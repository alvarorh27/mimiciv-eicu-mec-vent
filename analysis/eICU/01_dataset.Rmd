---
title: "01_dataset_creation"
author: "Álvaro Ritoré"
date: '`r format(Sys.Date(), "%B %d, %Y")`'
# output:
#   html_notebook:
#     code_folding: hide
#     number_sections: yes
#     theme: flatly
#     toc: yes
#     toc_float: yes
---

# Environment

```{r message=FALSE, warning=FALSE}
library(bigrquery)
library(DBI)
library(dplyr)
library(summarytools)
library(sqldf)
library(tidyverse)
library(nlme)
library(zoo)
library(tableone)
library(readxl)
library(feather)
library(magrittr)
library(MatchIt)
library(kableExtra)
library(ggplot2)
library(naniar)
library(modeest)
```

# BigQuery related functions

This chunks creates the run_query and getSQL function.

```{r}

# Function that takes in a SQL command and runs it on BigQuery. This avoids the connection data in each iteration
run_query<-function(query){
  query_output<-dbGetQuery(con,query)
  return(query_output)
}

# Function for reading SQL files from a folder
getSQL <- function(filepath) {
  con = file(filepath, "r")
  sql.string <- ""
  while (TRUE) {
    line <- readLines(con, n = 1)
    if (length(line) == 0) {
      break
    }
    line <- gsub("\\t", " ", line)
    if (grepl("--", line) == TRUE) {
      line <- paste(sub("--", "/*", line), "*/")
    }
    sql.string <- paste(sql.string, line)
  }
  close(con)
  return(sql.string)
}
```

# Setting up connection with BigQuery

```{r}
bigrquery::bq_auth() # UNCOMMENT WHEN HAVEN TOCKEN ISSUES!!!
# Establecer la conexión a BigQuery
project_id <- readline(prompt = "Enter your project ID: ")

con <- dbConnect(
  bigrquery::bigquery(),
  project = project_id
)

```

# Data Load

Loading queries and extracting the data

## Prolonged Mechanical Ventilation

```{r}
# Criterion of prolonged mechanical ventilation: highest number of consecutive days of mechanical ventilation six or more hours per day
vm_consecutive_days <- run_query(getSQL("sql/vm_consecutive_days_eicu.sql"))

# Criterion of prolonged mechanical ventilation: total consecutive or non-consecutive days of mechanical ventilation for six or more hours per day

# Criterion of prolonged mechanical ventilation: 96 hour ventilation + tracheotomy

```

## Traumatisms

```{r}
#Traumatic Brain Injury
tbi <- run_query(getSQL("sql/tbi_eicu.sql"))
tbi %<>%
  group_by(stay_id) %>%
  summarize(
    tbi_seq1=max(tbi_seq1), 
    tbi_anyseq=max(tbi_anyseq))

#General traumatisms
trauma_general <- run_query(getSQL("sql/trauma_general_eicu.sql"))
trauma_general %<>%
  group_by(stay_id) %>%
  summarize(
    traumatic_general_min_diagnosisoffset=max(traumatic_general_min_diagnosisoffset), 
    traumatic_general_any_diagnosisoffset=max(traumatic_general_any_diagnosisoffset))

#Fractures
trauma_fractures <- run_query(getSQL("sql/trauma_fractures_eicu.sql"))
trauma_fractures %<>%
  group_by(stay_id) %>%
  summarize(
    fractures_min_diagnosisoffset=max(fractures_min_diagnosisoffset),
    fractures_any_diagnosisoffset=max(fractures_any_diagnosisoffset))

#Luxations
trauma_luxations <- run_query(getSQL("sql/trauma_luxations_eicu.sql"))
trauma_luxations %<>%
  group_by(stay_id) %>%
  summarize(
    luxation_min_diagnosisoffset=max(luxation_min_diagnosisoffset),
    luxation_any_diagnosisoffset=max(luxation_any_diagnosisoffset))

#Sprains
trauma_sprains <- run_query(getSQL("sql/trauma_sprains_eicu.sql"))

#Burns
trauma_burns <- run_query(getSQL("sql/trauma_burns_eicu.sql"))
trauma_burns %<>%
  group_by(stay_id) %>%
  summarize(
    burns_min_diagnosisoffset=max(burns_min_diagnosisoffset),
    burns_any_diagnosisoffset=max(burns_any_diagnosisoffset))

#Contusion
trauma_contusion <- run_query(getSQL("sql/trauma_contusions_eicu.sql"))

```

## Demographic information

```{r}
#Patients
patient <- run_query(getSQL("sql/patient_eicu.sql"))

#Stays in ICU
icustays <- run_query(getSQL("sql/icustays_eicu.sql"))
```

## Severity scores

```{r}
#Table apachepatientresult 
apachepatientresult <- run_query(getSQL("sql/apachepatientresult_eicu.sql"))
apachepatientresult %<>%
  group_by(patientunitstayid) %>%
  arrange (apachepatientresultsid) %>%
  filter(row_number() == 1)

#Table apachepredvar 
apachepredvar <- run_query(getSQL("sql/apachepredvar_eicu.sql"))

```

# Creation of Final Dataset

## Joining across datasets

```{r}
# Join patients tables by patientunitstayid
dataset_join <- Reduce(function(...) merge(..., by = c("patientunitstayid"), all.x=TRUE, sort = TRUE), list(
  icustays, 
  patient, 
  apachepatientresult, 
  apachepredvar))

# Rename patientunitstayid to stay_id
dataset_join %<>%
  rename("stay_id" = patientunitstayid)

# Join tables by stay_id
dataset_join <- Reduce(function(...) merge(..., by = c("stay_id"), all.x=TRUE, sort = TRUE), list(
  dataset_join, 
  vm_consecutive_days, 
  trauma_burns, 
  tbi,
  trauma_contusion, 
  trauma_fractures, 
  trauma_general, 
  trauma_luxations, 
  trauma_sprains))

```

## Creation of new variables and adjustment

```{r}
# Convert columns names to lowercase
names(dataset_join) <- tolower(names(dataset_join))

# Rename columns for self-explanation purposes
total_dataset <- dataset_join %>%
  rename(
    "subject_id" = uniquepid.x, #individual code for each patient
    "hadm_id" = patienthealthsystemstayid.x, #individual code for each hospital admission
    "hospital_stay_days" = unabridgedhosplos, #Hospital Length of stay from apachePatientResult table. 
    "inhospital_death" = hosp_mort, #patient death within the given hospital stay from icustays table
    "inicu_death" = unitdischargestatus, #patient death within the given ICU stay from patient table
    "discharge_location" = hospitaldischargelocation, #location where the patient was discharged to from the hospital e.g.: Home, Nursing Home, Death, etc.
    "apsiv" = acutephysiologyscore, #APS score (IV or IVa versions) from apachepatientresults table
    "apache" = apachescore, #Apache Score. Calculated from acutePhysiologyScore
    "gcs_verbal" = day1verbal, #from apachepredvar table
    "gcs_motor" = day1motor, #from apachepredvar table
    "gcs_eyes" = day1eyes #from apachepredvar table
    )

#Transform variables
total_dataset %<>%
  mutate(age.x = as.integer(ifelse(age.x == "> 89", 89, age.x)), #Convert >89 age values to 89
         age.x = ifelse(age.x == "", NA, age.x), #Convert blank values to NA
         gender.x = case_when(gender.x == 1 ~ "Female", gender.x == 0 ~ "Male", TRUE ~ NA_character_), #Convert 1 to "Female", 0 to "Male" and the rest to NA
         icu_stay_days = round(icu_los_hours/24, 2), #Convert UCI hours to days
         hospital_stay_days_all = round((hospitaldischargeoffset.x - hospitaladmitoffset.x)/1440,2), 
         discharge_location = ifelse(discharge_location == "", NA, discharge_location), #Convert blank values to NA
         inicu_death = case_when(inicu_death == "Expired" ~ 1, inicu_death == "Alive" ~ 0, inicu_death == "" ~ NA), #Convert Expired to 1, Alive to 0 and null to NA
         discharge_location = ifelse(is.na(discharge_location) & inicu_death == 1, "Death", discharge_location), #for NA values in discharge_location variable, fill with "Death" when the patient died in ICU
         inhospital_death = ifelse(is.na(inhospital_death) & inicu_death == 1, 1, inhospital_death) #for NA values in inhospital_death variable, fill with 1 when the patient died in ICU, since if the patient died in ICU therefore he died in hospital as well
          )

# Create variable days_of_death and death_30days
total_dataset %<>%
  mutate(days_of_death = as.numeric(ifelse(discharge_location == "Death", hospital_stay_days_all, -1)), #if the patient is dead, the hospital length of stay represents the days of death from hospital admission. If the patient is alive, a value of -1 is given  
         death_30days = ifelse(days_of_death <=30 & days_of_death != -1, 1, 0) #patient death before 30 days from ICU admission
         )

# Traumatism variables
total_dataset %<>%
  mutate(
    anytrauma_seq1 = as.integer(ifelse(tbi_seq1 == 1 | fractures_min_diagnosisoffset == 1 | traumatic_general_min_diagnosisoffset == 1 | luxation_min_diagnosisoffset == 1, 1, 0)),          
    anytrauma_anyseq = as.integer(ifelse(tbi_anyseq == 1 | fractures_any_diagnosisoffset == 1 | traumatic_general_any_diagnosisoffset == 1 | luxation_any_diagnosisoffset == 1, 1, 0)),
            )

# Variables mv_14days (prolonged mechanical ventilation, criterion of 14 days) and mv_96traq (prolonged mechanical ventilation, criterion of 96h of ventilation + traqueostomy)
total_dataset %<>%
  mutate(
    mv_consecutive_7days = as.integer(ifelse(consecutive_vm_days>=7, 1, 0)),
    mv_consecutive_14days = as.integer(ifelse(consecutive_vm_days>=14, 1, 0)),
    mv_consecutive_21days = as.integer(ifelse(consecutive_vm_days>=21, 1, 0)),
    prolonged_mec_vent = as.integer(ifelse(mv_consecutive_14days == 1, 1, 0))
  )

```

## Selection of required columns

```{r}
# Select the desired columns and order the result
total_dataset_selected <- total_dataset %>%
  select(subject_id, hadm_id, stay_id, unitvisitnumber.x, age.x, gender.x, hospital_stay_days, hospital_stay_days_all, icu_stay_days, discharge_location, inhospital_death, inicu_death, days_of_death, death_30days, tbi_seq1, tbi_anyseq, anytrauma_seq1, anytrauma_anyseq, consecutive_vm_days, mv_consecutive_7days, mv_consecutive_14days, mv_consecutive_21days, prolonged_mec_vent, apsiv, apache, gcs_verbal, gcs_motor, gcs_eyes) %>%
  rename("age" = age.x,
         "gender" = gender.x,
         "unitvisitnumber" = unitvisitnumber.x) %>% 
  arrange(subject_id, unitvisitnumber)
```

## Addressing missingness

```{r}
# Map missingness in total_dataset before NA filling  
##Columns with na values
print('Columns in total_dataset having NAs')
names(total_dataset_selected)[colSums(is.na(total_dataset_selected)) > 0]

print('Nº of columns with na values')
n_var_miss(total_dataset_selected)

##Plot columns and show descriptive table with NA values
miss_summary_preclean <- miss_var_summary(total_dataset_selected)
miss_summary_preclean
gg_miss_var(total_dataset_selected, show_pct=TRUE)
  
```
## NA filling
```{r}
# Columns NA filling
total_dataset_clean <- total_dataset_selected %>%
  mutate(
    age = as.integer(ifelse(is.na(age), modeest::mfv(age, na_rm=TRUE), age)), # NAs are filled with the most frequent value (mode)
    gender = as.factor(fct_explicit_na(gender, na_level = "Unknown")), #NA values of gender are converted to "Unknown"
    gender = relevel(gender, ref = "Male"), #change reference level of factor gender variable to "Male"
    discharge_location = as.factor(ifelse(is.na(discharge_location), modeest::mfv(discharge_location), discharge_location)), # as a non-dichotomous categorical variable, NAs are filled with the most frequent value (mode)
    across(c(inhospital_death, inicu_death, death_30days:prolonged_mec_vent), ~ifelse(is.na(.), 0, .)), #NA values from dichotomous variables are filled with 0
    across(c(inhospital_death, inicu_death, death_30days:prolonged_mec_vent), as.integer),
    #apsiv and apache variables are omitted since they display a 26% of NA values
    across(gcs_verbal:gcs_eyes, ~ifelse(. == -1, 1, .)), #convert values equal to -1 to 1, the minimal value for each gcs variable. This could be due in eICU database to various reasons, such as the patient being intubated, sedated, paralyzed or with an eye injury that prevents evaluating their response. In these cases, a value of -1 is assigned to indicate that the data is missing or not applicable.
    across(gcs_verbal:gcs_eyes, ~ifelse(is.na(.), modeest::mfv(., na_rm=TRUE), .)), #fill NA values with the mode
    gcs_min = as.integer(gcs_verbal + gcs_motor + gcs_eyes) #total gcs value is the sum of verbal, motor and eyes (minimum: 3, maximum: 15)
  )

total_dataset_clean_selected <- total_dataset_clean %>%
  select(-c(hospital_stay_days, days_of_death, apsiv, apache))
```

## Confirm 0% missingness
```{r}
# Map missingness in total_dataset_clean after NA filling  
##Columns with na values
print('Columns in total_dataset_clean having NAs')
names(total_dataset_clean_selected)[colSums(is.na(total_dataset_clean_selected)) > 0]

print('Nº of columns with na values')
n_var_miss(total_dataset_clean_selected)

##Plot columns and show descriptive table with NA values
miss_summary_postclean <- miss_var_summary(total_dataset_clean_selected)
miss_summary_postclean
gg_miss_var(total_dataset_clean_selected, show_pct=TRUE)
  
```

## Creation of additional variables
```{r}
# Create variable tbi severe and non-severe tbi, as well as trauma_type, containing 4 types of trauma in our dataset: TBI, general traumatism without TBI, severe TBI, non-severe TBI, for both seq1 and anyseq 
total_dataset_clean_selected %<>%
  mutate(
    tbi_severe_seq1 = as.integer(ifelse(tbi_seq1 == 1 & gcs_min <= 8, 1, 0)),
    tbi_nonsevere_seq1 = as.integer(ifelse(tbi_seq1 == 1 & gcs_min > 8, 1, 0)),
    trauma_type_seq1 = as.factor(
      ifelse(anytrauma_seq1 == 0, "non_trauma",
             ifelse(anytrauma_seq1 == 1 & tbi_seq1 == 0, "trauma_non_tbi",
                    ifelse(tbi_severe_seq1 == 1, "tbi_severe",
                           ifelse(tbi_nonsevere_seq1 == 1, "tbi_non_severe", NA)))
      )
    ),
    tbi_severe_anyseq = as.integer(ifelse(tbi_anyseq == 1 & gcs_min <= 8, 1, 0)),
    tbi_nonsevere_anyseq = as.integer(ifelse(tbi_anyseq == 1 & gcs_min > 8, 1, 0)),
    trauma_type_anyseq = as.factor(
      ifelse(anytrauma_anyseq == 0, "non_trauma",
             ifelse(anytrauma_anyseq == 1 & tbi_anyseq == 0, "trauma_non_tbi",
                    ifelse(tbi_severe_anyseq == 1, "tbi_severe",
                           ifelse(tbi_nonsevere_anyseq == 1, "tbi_non_severe", NA)))
      )
    )
  )

# Select and order columns
total_dataset_clean_selected %<>% 
  select(subject_id:anytrauma_anyseq, tbi_severe_seq1, tbi_nonsevere_seq1, trauma_type_seq1, tbi_severe_anyseq, tbi_nonsevere_anyseq, trauma_type_anyseq, consecutive_vm_days:prolonged_mec_vent, gcs_min) %>%
  arrange(subject_id, unitvisitnumber)
```


## Final Dataset
```{r}
# Group all stay_id within joint hospital admissions

#Summarizing variables into hadm_id groups
final_dataset_hadmid <- total_dataset_clean_selected %>%
  group_by(subject_id, hadm_id) %>%
  arrange (unitvisitnumber) %>% 
  summarize(
    age=min(age), 
    gender=first(gender), 
    unitvisitnumber=n(), 
    hospital_stay_days_all=first(hospital_stay_days_all),
    icu_stay_days=sum(icu_stay_days), 
    discharge_location=last(discharge_location),
    inhospital_death=max(inhospital_death), 
    inicu_death=max(inicu_death), 
    death_30days=max(death_30days), 
    tbi_seq1=first(tbi_seq1), 
    tbi_anyseq=first(tbi_anyseq), 
    anytrauma_seq1=first(anytrauma_seq1),
    anytrauma_anyseq=first(anytrauma_anyseq),
    tbi_severe_seq1=first(tbi_severe_seq1), 
    tbi_nonsevere_seq1=first(tbi_nonsevere_seq1),
    trauma_type_seq1=first(trauma_type_seq1),
    tbi_severe_anyseq=first(tbi_severe_anyseq), 
    tbi_nonsevere_anyseq=first(tbi_nonsevere_anyseq),
    trauma_type_anyseq=first(trauma_type_anyseq),
    consecutive_vm_days=max(consecutive_vm_days), 
    mv_consecutive_7days=max(mv_consecutive_7days), 
    mv_consecutive_14days=max(mv_consecutive_14days),
    mv_consecutive_21days=max(mv_consecutive_21days),
    prolonged_mec_vent=max(prolonged_mec_vent), 
    gcs_min = min(gcs_min)
          ) %>%
    arrange(subject_id)

```
# Export file

```{r}
write.csv(final_dataset_hadmid,'C:/Users/se_al/Documents/GitHub/mimiciv-mec-vent/data/eICU/final_dataset.csv', row.names = F)
```

