---
title: "03_modeling"
# output: html_document
---

# Environment

```{r}
library(skimr)
library(mgcv)
library(parallel)
library(parglm)
library(pROC)
library(ggplot2)
library(tibble)
library(dplyr)
library(feather)
library(broom)
library(htmlTable)
library(randomForest)
library(caret)
library(kableExtra)
library(magick)
library(gridExtra)
library(webshot2)


extract_coef_pval_OR <- function(model) {
  
  as.data.frame(tibble(term = names(model$coefficients),
                       estimate = model$coefficients,
                       std.error = sqrt(diag(vcov(model))),
                       statistic = model$coefficients / sqrt(diag(vcov(model))),
                       p.value = 2 * (1 - pnorm(abs(statistic))),
                       OR = round(exp(estimate),2),
                       OR_lower = round(exp(estimate - 1.96 * std.error),2),
                       OR_upper = round(exp(estimate + 1.96 * std.error),2)
  )
  )
} 
```

# Load File

```{r}
final_dataset_MIMICIV <- read.csv('C:/Users/se_al/Documents/GitHub/mimiciv-mec-vent/data/mimic-iv/final_dataset_MIMICIV.csv')
```


# Logistic Regression with interaction: Hospital death

## Hospital Mortality: Ref non_trauma

### Fitting the model

```{r}
print('Logistic Regression of hospital mortality')
print(Sys.time())
logreg_hospdeath <- glm(
   inhospital_death ~ prolonged_mec_vent * trauma_type_anyseq + age + sex + apsiii + charlson,
  data = final_dataset_MIMICIV,
  family = binomial())
print(Sys.time())
```

### Odds ratio and Forest plot

```{r}
# Extract Odds ratio
or_hospdeath_1 <- extract_coef_pval_OR(logreg_hospdeath)

# Order variables
variable_order <- rev(c(
  "Intercept", "Age (years)", "Sex (male)", "PMV", "TBI-non severe", "TBI-severe", "Trauma-not TBI", "PMV + TBI-non severe", "PMV + TBI-severe", "PMV + Trauma - no TBI"))

# Assign proper names to OR table
or_hospdeath_2_non_trauma <- or_hospdeath_1 %>% 
  mutate(term = case_when(term == "(Intercept)" ~ "Intercept",
                          term == "prolonged_mec_vent" ~ "PMV",
                          term == "trauma_type_anyseqtbi_non_severe" ~ "TBI-non severe",
                          term == "trauma_type_anyseqtbi_severe" ~ "TBI-severe",
                          term == "trauma_type_anyseqtrauma_non_tbi" ~ "Trauma-not TBI",
                          term == "prolonged_mec_vent:trauma_type_anyseqtbi_non_severe" ~ "PMV + TBI-non severe",
                          term == "prolonged_mec_vent:trauma_type_anyseqtbi_severe" ~ "PMV + TBI-severe",
                          term == "prolonged_mec_vent:trauma_type_anyseqtrauma_non_tbi" ~ "PMV + Trauma - no TBI",
                          term == "age" ~ "Age (years)",
                          term == "sexM" ~ "Sex (male)",
                          TRUE ~ term), 
         term = factor(term, levels = variable_order),
         adverse_protective = case_when(
           OR_lower > 1 & OR_upper > 1 ~ "Adverse",
           OR_lower < 1 & OR_upper < 1 ~ "Protective",
           TRUE ~ "Inconclusive"
    ),
    adverse_protective = factor(adverse_protective, levels = c("Adverse", "Protective", "Inconclusive"))) %>%
  filter(term != "Intercept")

# Save PMV's OR for this specific model 
or_hospdeath_PMV_nontrauma_mimiciv <- or_hospdeath_2_non_trauma[or_hospdeath_2_non_trauma[,1]=="PMV", c(1,6:9)]
or_hospdeath_PMV_nontrauma_mimiciv[, 1] <- "PMV for non-Trauma"

# Save OR table and print in console
write.csv(or_hospdeath_2_non_trauma,'C:/Users/se_al/Documents/GitHub/mimiciv-mec-vent/data/mimic-iv/or_hospdeath_PMV-nontrauma_mimiciv.csv')
htmlTable(or_hospdeath_2_non_trauma[,c("term","OR","OR_lower","OR_upper")], caption = "Logistic Regression. Odds Ratio and Confidence Intervals for Hospital Mortality-associated Factors. MIMIC-IV Database")

# Export OR table as kable 
or_table <- or_hospdeath_2_non_trauma %>%
  select(term, OR, OR_lower, OR_upper) %>%
  mutate(
    term = factor(term, levels = variable_order),
    OR_upper = ifelse(OR_upper <= 100, sprintf("%.2f", OR_upper), sprintf("%.2e", OR_upper))) %>%
  arrange(desc(term)) %>%
  kbl(caption = "Logistic Regression. Odds Ratio and Confidence Intervals for Hospital Mortality-associated Factors. MIMIC-IV Database" , align = "c") %>%
  kable_classic_2(full_width = F, html_font = "Cambria") %>%
  save_kable("C:/Users/se_al/Documents/GitHub/mimiciv-mec-vent/figures/mimic-iv/Odds_ratio/or_hospdeath_PMV-nontrauma_mimiciv.png",
             zoom = 10)
 
# Build the Forest plot
ggplot(or_hospdeath_2_non_trauma, 
       aes(x = OR, xmin = OR_lower, xmax = OR_upper, y = term)) +
  geom_point(size = 2, aes(color = adverse_protective)) +
  geom_errorbarh(height = 0.2, aes(color = adverse_protective)) +
  geom_vline(xintercept = 1, linetype = "dashed") +
  labs(x = "Odds Ratio", y = NULL, title = "Logistic Regression. Odds Ratio and Confidence Intervals\nfor Hospital Mortality-associated Factors. MIMIC-IV Database") +
  theme_minimal() +
  scale_color_manual(
    values = c("#c0392b", "#27ae60", "gray70"),
    labels = c("Adverse", "Protective", "Inconclusive"),
    name = "Effect on Outcome", 
    limits = adverse_protective_levels$adverse_protective) + #establishes limits of color scale
  scale_x_continuous(limits = c(0, 17)) +
  theme(
    plot.background = element_rect(fill = "white"),
    panel.grid.major.y = element_blank(),
    panel.grid.minor.y = element_blank(),
    plot.title = element_text(hjust = 0.5),
    legend.position = "top",
    axis.ticks = element_blank(),
    axis.text.x = element_text(color = "#2c3e50"),
    axis.text.y = element_text(color = "#2c3e50"
    ))

# Save the Forest plot as a PNG file
ggsave("C:/Users/se_al/Documents/GitHub/mimiciv-mec-vent/figures/mimic-iv/Forest_plot/fp_hospdeath_PMV-nontrauma_mimiciv.png", width = 10, height = 4, dpi = 300)
```

## Hospital Mortality: Ref trauma_non_tbi

### Fitting the model

```{r}
# Recategorize tbi_severe as reference level in trauma_type_anyseq
final_dataset_MIMICIV_trauma_non_tbi <- final_dataset_MIMICIV %>%
  mutate(trauma_type_anyseq = as.factor(trauma_type_anyseq),
    trauma_type_anyseq = relevel(trauma_type_anyseq, ref = "trauma_non_tbi"))

print('Logistic Regression of hospital mortality')
print(Sys.time())
logreg_hospdeath <- glm(
   inhospital_death ~ prolonged_mec_vent * trauma_type_anyseq + age + sex + apsiii + charlson,
  data = final_dataset_MIMICIV_trauma_non_tbi,
  family = binomial())
print(Sys.time())
```

### Odds ratio and Forest plot

```{r}
# Extract Odds ratio
or_hospdeath_1 <- extract_coef_pval_OR(logreg_hospdeath)

# Order variables
variable_order <- rev(c(
  "Intercept", "Age (years)", "Sex (male)", "PMV", "TBI-severe", "Non Trauma", "TBI-non severe", "PMV + TBI-severe", "PMV + Non Trauma", "PMV + TBI-non severe"))

# Assign proper names to OR table
or_hospdeath_2_trauma_non_tbi <- or_hospdeath_1 %>% 
  mutate(term = case_when(term == "(Intercept)" ~ "Intercept",
                          term == "prolonged_mec_vent" ~ "PMV",
                          term == "trauma_type_anyseqtbi_non_severe" ~ "TBI-non severe",
                          term == "trauma_type_anyseqtbi_severe" ~ "TBI-severe",
                          term == "trauma_type_anyseqtrauma_non_tbi" ~ "Trauma-not TBI",
                          term == "trauma_type_anyseqnon_trauma" ~ "Non Trauma",
                          term == "prolonged_mec_vent:trauma_type_anyseqtbi_non_severe" ~ "PMV + TBI-non severe",
                          term == "prolonged_mec_vent:trauma_type_anyseqtbi_severe" ~ "PMV + TBI-severe",
                          term == "prolonged_mec_vent:trauma_type_anyseqtrauma_non_tbi" ~ "PMV + Trauma - no TBI",
                          term == "prolonged_mec_vent:trauma_type_anyseqnon_trauma" ~ "PMV + Non Trauma",
                          term == "age" ~ "Age (years)",
                          term == "sexM" ~ "Sex (male)",
                          TRUE ~ term), 
         term = factor(term, levels = variable_order),
         adverse_protective = case_when(
           OR_lower > 1 & OR_upper > 1 ~ "Adverse",
           OR_lower < 1 & OR_upper < 1 ~ "Protective",
           TRUE ~ "Inconclusive"
    ),
    adverse_protective = factor(adverse_protective, levels = c("Adverse", "Protective", "Inconclusive"))) %>%
  filter(term != "Intercept")

# Save PMV's OR for this specific model 
or_hospdeath_PMV_traumanontbi_mimiciv <- or_hospdeath_2_trauma_non_tbi[or_hospdeath_2_trauma_non_tbi[,1]=="PMV", c(1,6:9)]
or_hospdeath_PMV_traumanontbi_mimiciv[, 1] <- "PMV for Trauma not TBI"

# Save OR table and print in console
write.csv(or_hospdeath_2_trauma_non_tbi,'C:/Users/se_al/Documents/GitHub/mimiciv-mec-vent/data/mimic-iv/or_hospdeath_PMV-TraumanotTBI_mimiciv.csv')
htmlTable(or_hospdeath_2_trauma_non_tbi[,c("term","OR","OR_lower","OR_upper")], caption = "Logistic Regression. Odds Ratio and Confidence Intervals for Hospital Mortality-associated Factors. MIMIC-IV Database")

# Export OR table as kable 
or_table <- or_hospdeath_2_trauma_non_tbi %>%
  select(term, OR, OR_lower, OR_upper) %>%
  mutate(
    term = factor(term, levels = variable_order),
    OR_upper = ifelse(OR_upper <= 100, sprintf("%.2f", OR_upper), sprintf("%.2e", OR_upper))) %>%
  arrange(desc(term)) %>%
  kbl(caption = "Logistic Regression. Odds Ratio and Confidence Intervals for Hospital Mortality-associated Factors. MIMIC-IV Database" , align = "c") %>%
  kable_classic_2(full_width = F, html_font = "Cambria") %>%
  save_kable("C:/Users/se_al/Documents/GitHub/mimiciv-mec-vent/figures/mimic-iv/Odds_ratio/or_hospdeath_PMV-TraumanotTBI_mimiciv.png",
             zoom = 10)
 
# Build the Forest plot
ggplot(or_hospdeath_2_trauma_non_tbi, 
       aes(x = OR, xmin = OR_lower, xmax = OR_upper, y = term)) +
  geom_point(size = 2, aes(color = adverse_protective)) +
  geom_errorbarh(height = 0.2, aes(color = adverse_protective)) +
  geom_vline(xintercept = 1, linetype = "dashed") +
  labs(x = "Odds Ratio", y = NULL, title = "Logistic Regression. Odds Ratio and Confidence Intervals\nfor Hospital Mortality-associated Factors. MIMIC-IV Database") +
  theme_minimal() +
  scale_color_manual(
    values = c("#c0392b", "#27ae60", "gray70"),
    labels = c("Adverse", "Protective", "Inconclusive"),
    name = "Effect on Outcome", 
    limits = adverse_protective_levels$adverse_protective) + #establishes limits of color scale
  scale_x_continuous(limits = c(0, 17)) +
  theme(
    plot.background = element_rect(fill = "white"),
    panel.grid.major.y = element_blank(),
    panel.grid.minor.y = element_blank(),
    plot.title = element_text(hjust = 0.5),
    legend.position = "top",
    axis.ticks = element_blank(),
    axis.text.x = element_text(color = "#2c3e50"),
    axis.text.y = element_text(color = "#2c3e50"
    ))

# Save the Forest plot as a PNG file
ggsave("C:/Users/se_al/Documents/GitHub/mimiciv-mec-vent/figures/mimic-iv/Forest_plot/fp_hospdeath_PMV-TraumanotTBI_mimiciv.png", width = 10, height = 4, dpi = 300)
```

## Hospital Mortality: Ref tbi_non_severe

### Fitting the model

```{r}
# Recategorize tbi_severe as reference level in trauma_type_anyseq
final_dataset_MIMICIV_tbi_non_severe <- final_dataset_MIMICIV %>%
  mutate(trauma_type_anyseq = as.factor(trauma_type_anyseq),
    trauma_type_anyseq = relevel(trauma_type_anyseq, ref = "tbi_non_severe"))

print('Logistic Regression of hospital mortality')
print(Sys.time())
logreg_hospdeath <- glm(
   inhospital_death ~ prolonged_mec_vent * trauma_type_anyseq + age + sex + apsiii + charlson,
  data = final_dataset_MIMICIV_tbi_non_severe,
  family = binomial())
print(Sys.time())
```

### Odds ratio and Forest plot

```{r}
# Extract Odds ratio
or_hospdeath_1 <- extract_coef_pval_OR(logreg_hospdeath)

# Order variables
variable_order <- rev(c(
  "Intercept", "Age (years)", "Sex (male)", "PMV", "TBI-severe", "Non Trauma", "Trauma-not TBI", "PMV + TBI-severe", "PMV + Non Trauma", "PMV + Trauma - no TBI"))

# Assign proper names to OR table
or_hospdeath_2_tbi_non_severe <- or_hospdeath_1 %>% 
  mutate(term = case_when(term == "(Intercept)" ~ "Intercept",
                          term == "prolonged_mec_vent" ~ "PMV",
                          term == "trauma_type_anyseqtbi_non_severe" ~ "TBI-non severe",
                          term == "trauma_type_anyseqtbi_severe" ~ "TBI-severe",
                          term == "trauma_type_anyseqtrauma_non_tbi" ~ "Trauma-not TBI",
                          term == "trauma_type_anyseqnon_trauma" ~ "Non Trauma",
                          term == "prolonged_mec_vent:trauma_type_anyseqtbi_non_severe" ~ "PMV + TBI-non severe",
                          term == "prolonged_mec_vent:trauma_type_anyseqtbi_severe" ~ "PMV + TBI-severe",
                          term == "prolonged_mec_vent:trauma_type_anyseqtrauma_non_tbi" ~ "PMV + Trauma - no TBI",
                          term == "prolonged_mec_vent:trauma_type_anyseqnon_trauma" ~ "PMV + Non Trauma",
                          term == "age" ~ "Age (years)",
                          term == "sexM" ~ "Sex (male)",
                          TRUE ~ term), 
         term = factor(term, levels = variable_order),
         adverse_protective = case_when(
           OR_lower > 1 & OR_upper > 1 ~ "Adverse",
           OR_lower < 1 & OR_upper < 1 ~ "Protective",
           TRUE ~ "Inconclusive"
    ),
    adverse_protective = factor(adverse_protective, levels = c("Adverse", "Protective", "Inconclusive"))) %>%
  filter(term != "Intercept")

# Save PMV's OR for this specific model 
or_hospdeath_PMV_tbinonsevere_mimiciv <- or_hospdeath_2_tbi_non_severe[or_hospdeath_2_tbi_non_severe[,1]=="PMV", c(1,6:9)]
or_hospdeath_PMV_tbinonsevere_mimiciv[, 1] <- "PMV for TBI non-severe"

# Save OR table and print in console
write.csv(or_hospdeath_2_tbi_non_severe,'C:/Users/se_al/Documents/GitHub/mimiciv-mec-vent/data/mimic-iv/or_hospdeath_PMV-TBInonsevere_mimiciv.csv')
htmlTable(or_hospdeath_2_tbi_non_severe[,c("term","OR","OR_lower","OR_upper")], caption = "Logistic Regression. Odds Ratio and Confidence Intervals for Hospital Mortality-associated Factors. MIMIC-IV Database")

# Export OR table as kable 
or_table <- or_hospdeath_2_tbi_non_severe %>%
  select(term, OR, OR_lower, OR_upper) %>%
  mutate(
    term = factor(term, levels = variable_order),
    OR_upper = ifelse(OR_upper <= 100, sprintf("%.2f", OR_upper), sprintf("%.2e", OR_upper))) %>%
  arrange(desc(term)) %>%
  kbl(caption = "Logistic Regression. Odds Ratio and Confidence Intervals for Hospital Mortality-associated Factors. MIMIC-IV Database" , align = "c") %>%
  kable_classic_2(full_width = F, html_font = "Cambria") %>%
  save_kable("C:/Users/se_al/Documents/GitHub/mimiciv-mec-vent/figures/mimic-iv/Odds_ratio/or_hospdeath_PMV-TBInonsevere_mimiciv.png",
             zoom = 10)
 
# Build the Forest plot
ggplot(or_hospdeath_2_tbi_non_severe, 
       aes(x = OR, xmin = OR_lower, xmax = OR_upper, y = term)) +
  geom_point(size = 2, aes(color = adverse_protective)) +
  geom_errorbarh(height = 0.2, aes(color = adverse_protective)) +
  geom_vline(xintercept = 1, linetype = "dashed") +
  labs(x = "Odds Ratio", y = NULL, title = "Logistic Regression. Odds Ratio and Confidence Intervals\nfor Hospital Mortality-associated Factors. MIMIC-IV Database") +
  theme_minimal() +
  scale_color_manual(
    values = c("#c0392b", "#27ae60", "gray70"),
    labels = c("Adverse", "Protective", "Inconclusive"),
    name = "Effect on Outcome", 
    limits = adverse_protective_levels$adverse_protective) + #establishes limits of color scale
  scale_x_continuous(limits = c(0, 22)) +
  theme(
    plot.background = element_rect(fill = "white"),
    panel.grid.major.y = element_blank(),
    panel.grid.minor.y = element_blank(),
    plot.title = element_text(hjust = 0.5),
    legend.position = "top",
    axis.ticks = element_blank(),
    axis.text.x = element_text(color = "#2c3e50"),
    axis.text.y = element_text(color = "#2c3e50"
    ))

# Save the Forest plot as a PNG file
ggsave("C:/Users/se_al/Documents/GitHub/mimiciv-mec-vent/figures/mimic-iv/Forest_plot/fp_hospdeath_PMV-TBInonsevere_mimiciv.png", width = 10, height = 4, dpi = 300)
```

## Hospital Mortality: Ref tbi_severe

### Fitting the model

```{r}
# Recategorize tbi_severe as reference level in trauma_type_anyseq
final_dataset_MIMICIV_tbi_severe <- final_dataset_MIMICIV %>%
  mutate(trauma_type_anyseq = as.factor(trauma_type_anyseq),
    trauma_type_anyseq = relevel(trauma_type_anyseq, ref = "tbi_severe"))

print('Logistic Regression of hospital mortality')
print(Sys.time())
logreg_hospdeath <- glm(
   inhospital_death ~ prolonged_mec_vent * trauma_type_anyseq + age + sex + apsiii + charlson,
  data = final_dataset_MIMICIV_tbi_severe,
  family = binomial())
print(Sys.time())
```

### Odds ratio and Forest plot

```{r}
# Extract Odds ratio
or_hospdeath_1 <- extract_coef_pval_OR(logreg_hospdeath)

# Order variables
variable_order <- rev(c(
  "Intercept", "Age (years)", "Sex (male)", "PMV", "TBI-non severe", "Non Trauma", "Trauma-not TBI", "PMV + TBI-non severe", "PMV + Non Trauma", "PMV + Trauma - no TBI"))

# Assign proper names to OR table
or_hospdeath_2_tbi_severe <- or_hospdeath_1 %>% 
  mutate(term = case_when(term == "(Intercept)" ~ "Intercept",
                          term == "prolonged_mec_vent" ~ "PMV",
                          term == "trauma_type_anyseqtbi_non_severe" ~ "TBI-non severe",
                          term == "trauma_type_anyseqtbi_severe" ~ "TBI-severe",
                          term == "trauma_type_anyseqtrauma_non_tbi" ~ "Trauma-not TBI",
                          term == "trauma_type_anyseqnon_trauma" ~ "Non Trauma",
                          term == "prolonged_mec_vent:trauma_type_anyseqtbi_non_severe" ~ "PMV + TBI-non severe",
                          term == "prolonged_mec_vent:trauma_type_anyseqtbi_severe" ~ "PMV + TBI-severe",
                          term == "prolonged_mec_vent:trauma_type_anyseqtrauma_non_tbi" ~ "PMV + Trauma - no TBI",
                          term == "prolonged_mec_vent:trauma_type_anyseqnon_trauma" ~ "PMV + Non Trauma",
                          term == "age" ~ "Age (years)",
                          term == "sexM" ~ "Sex (male)",
                          TRUE ~ term), 
         term = factor(term, levels = variable_order),
         adverse_protective = case_when(
           OR_lower > 1 & OR_upper > 1 ~ "Adverse",
           OR_lower < 1 & OR_upper < 1 ~ "Protective",
           TRUE ~ "Inconclusive"
    ),
    adverse_protective = factor(adverse_protective, levels = c("Adverse", "Protective", "Inconclusive"))) %>%
  filter(term != "Intercept")

# Save PMV's OR for this specific model 
or_hospdeath_PMV_tbisevere_mimiciv <- or_hospdeath_2_tbi_severe[or_hospdeath_2_tbi_severe[,1]=="PMV", c(1,6:9)]
or_hospdeath_PMV_tbisevere_mimiciv[, 1] <- "PMV for TBI severe"

# Save OR table and print in console
write.csv(or_hospdeath_2_tbi_severe,'C:/Users/se_al/Documents/GitHub/mimiciv-mec-vent/data/mimic-iv/or_hospdeath_PMV-TBIsevere_mimiciv.csv')
htmlTable(or_hospdeath_2_tbi_severe[,c("term","OR","OR_lower","OR_upper")], caption = "Logistic Regression. Odds Ratio and Confidence Intervals for Hospital Mortality-associated Factors. MIMIC-IV Database")

# Export OR table as kable 
or_table <- or_hospdeath_2_tbi_severe %>%
  select(term, OR, OR_lower, OR_upper) %>%
  mutate(
    term = factor(term, levels = variable_order),
    OR_upper = ifelse(OR_upper <= 100, sprintf("%.2f", OR_upper), sprintf("%.2e", OR_upper))) %>%
  arrange(desc(term)) %>%
  kbl(caption = "Logistic Regression. Odds Ratio and Confidence Intervals for Hospital Mortality-associated Factors. MIMIC-IV Database" , align = "c") %>%
  kable_classic_2(full_width = F, html_font = "Cambria") %>%
  save_kable("C:/Users/se_al/Documents/GitHub/mimiciv-mec-vent/figures/mimic-iv/Odds_ratio/or_hospdeath_PMV-TBIsevere_mimiciv.png",
             zoom = 10)
 
# Build the Forest plot
ggplot(or_hospdeath_2_tbi_severe, 
       aes(x = OR, xmin = OR_lower, xmax = OR_upper, y = term)) +
  geom_point(size = 2, aes(color = adverse_protective)) +
  geom_errorbarh(height = 0.2, aes(color = adverse_protective)) +
  geom_vline(xintercept = 1, linetype = "dashed") +
  labs(x = "Odds Ratio", y = NULL, title = "Logistic Regression. Odds Ratio and Confidence Intervals\nfor Hospital Mortality-associated Factors. MIMIC-IV Database") +
  theme_minimal() +
  scale_color_manual(
    values = c("#c0392b", "#27ae60", "gray70"),
    labels = c("Adverse", "Protective", "Inconclusive"),
    name = "Effect on Outcome", 
    limits = adverse_protective_levels$adverse_protective) + #establishes limits of color scale
  scale_x_continuous(limits = c(0, 13)) +
  theme(
    plot.background = element_rect(fill = "white"),
    panel.grid.major.y = element_blank(),
    panel.grid.minor.y = element_blank(),
    plot.title = element_text(hjust = 0.5),
    legend.position = "top",
    axis.ticks = element_blank(),
    axis.text.x = element_text(color = "#2c3e50"),
    axis.text.y = element_text(color = "#2c3e50"
    ))

# Save the Forest plot as a PNG file
ggsave("C:/Users/se_al/Documents/GitHub/mimiciv-mec-vent/figures/mimic-iv/Forest_plot/fp_hospdeath_PMV-TBIsevere_mimiciv.png", width = 10, height = 4, dpi = 300)
```

## Combined results for PMV's OR for different trauma subsets

```{r}
# Obtain combined table
MIMICIV_or_hospdeath_PMV <- rbind(or_hospdeath_PMV_nontrauma_mimiciv, or_hospdeath_PMV_traumanontbi_mimiciv, or_hospdeath_PMV_tbinonsevere_mimiciv, or_hospdeath_PMV_tbisevere_mimiciv)

# Order variables
variable_order <- rev(c("Non Trauma", "non-TBI Trauma", "non-severe TBI", "severe TBI"))

# Assign proper names to OR table
MIMICIV_or_hospdeath_PMV_2 <- MIMICIV_or_hospdeath_PMV %>% 
  mutate(term = case_when(term == "(Intercept)" ~ "Intercept",
                          term == "PMV for Trauma not TBI" ~ "non-TBI Trauma",
                          term == "PMV for TBI non-severe" ~ "non-severe TBI",
                          term == "PMV for TBI severe" ~ "severe TBI",
                          term == "PMV for non-Trauma" ~ "Non Trauma",
                          TRUE ~ term), 
         term = factor(term, levels = variable_order),
         adverse_protective = case_when(
           OR_lower > 1 & OR_upper > 1 ~ "Adverse",
           OR_lower < 1 & OR_upper < 1 ~ "Protective",
           TRUE ~ "Inconclusive"
    ),
    adverse_protective = factor(adverse_protective, levels = c("Adverse", "Protective", "Inconclusive"))) %>%
  filter(term != "Intercept")

# Save OR table and print in console
write.csv(MIMICIV_or_hospdeath_PMV_2,'C:/Users/se_al/Documents/GitHub/mimiciv-mec-vent/data/mimic-iv/or_hospdeath_PMV_all-trauma_mimiciv.csv')
htmlTable(MIMICIV_or_hospdeath_PMV_2[,c("term","OR","OR_lower","OR_upper")], caption = "Odds Ratio and Confidence Intervals for factors associated with Hospital Mortality. All types of trauma. MIMIC-IV Database")

# Export OR table as kable 
or_table <- MIMICIV_or_hospdeath_PMV_2 %>%
  select(term, OR, OR_lower, OR_upper) %>%
  mutate(
    term = factor(term, levels = variable_order),
    OR_upper = ifelse(OR_upper <= 100, sprintf("%.2f", OR_upper), sprintf("%.2e", OR_upper))) %>%
  arrange(desc(term)) %>%
  kbl(caption = "Logistic Regression. Odds Ratio and Confidence Intervals for factors associated with Hospital Mortality. All types of trauma. MIMIC-IV Database" , align = "c") %>%
  kable_classic_2(full_width = F, html_font = "Cambria") %>%
  save_kable("C:/Users/se_al/Documents/GitHub/mimiciv-mec-vent/figures/mimic-iv/Odds_ratio/or_hospdeath_PMV_all-trauma_mimiciv.png",
             zoom = 10)
 
# Build the Forest plot
fp_PMV_alltraumas_hospdeath_mimiciv <- ggplot(MIMICIV_or_hospdeath_PMV_2, 
       aes(x = OR, xmin = OR_lower, xmax = OR_upper, y = term)) +
  geom_point(size = 2, aes(color = adverse_protective)) +
  geom_errorbarh(height = 0.2, aes(color = adverse_protective)) +
  geom_vline(xintercept = 1, linetype = "dashed") +
  labs(x = "Odds Ratio", y = NULL, title = "Logistic Regression. Odds Ratio and Confidence Intervals\nfor factors associated with Hospital Mortality.\nAll types of trauma. MIMIC-IV Database") +
  theme_minimal() +
  scale_color_manual(
    values = c("#c0392b", "#27ae60", "gray70"),
    labels = c("Adverse", "Protective", "Inconclusive"),
    name = "Effect on Outcome", 
    limits = adverse_protective_levels$adverse_protective) + #establishes limits of color scale
  scale_x_continuous(limits = c(0, 4)) +
  theme(
    plot.background = element_rect(fill = "white"),
    panel.grid.major.y = element_blank(),
    panel.grid.minor.y = element_blank(),
    plot.title = element_text(hjust = 0.5),
    legend.position = "top",
    axis.ticks = element_blank(),
    axis.text.x = element_text(color = "#2c3e50"),
    axis.text.y = element_text(color = "#2c3e50"
    ))
fp_PMV_alltraumas_hospdeath_mimiciv


# Save the Forest plot as a PNG file
ggsave("C:/Users/se_al/Documents/GitHub/mimiciv-mec-vent/figures/mimic-iv/Forest_plot/fp_hospdeath_PMV_all-trauma_mimiciv.png", plot=fp_PMV_alltraumas_hospdeath_mimiciv, width = 10, height = 4, dpi = 300)

```

# Logistic Regression with interaction: Death at year

## Death at year: Ref non_trauma

### Fitting the model

```{r}
print('Logistic Regression of mortality at 1 year')
print(Sys.time())
logreg_deathyear <- glm(
   death_year ~ prolonged_mec_vent * trauma_type_anyseq + age + sex + apsiii + charlson,
  data = final_dataset_MIMICIV,
  family = binomial())
print(Sys.time())
```

### Odds ratio and Forest plot

```{r}
# Extract Odds ratio
or_deathyear_1 <- extract_coef_pval_OR(logreg_deathyear)

# Order variables
variable_order <- rev(c(
  "Intercept", "Age (years)", "Sex (male)", "PMV", "TBI-non severe", "TBI-severe", "Trauma-not TBI", "PMV + TBI-non severe", "PMV + TBI-severe", "PMV + Trauma - no TBI"))

# Assign proper names to OR table
or_deathyear_2_non_trauma <- or_deathyear_1 %>% 
  mutate(term = case_when(term == "(Intercept)" ~ "Intercept",
                          term == "prolonged_mec_vent" ~ "PMV",
                          term == "trauma_type_anyseqtbi_non_severe" ~ "TBI-non severe",
                          term == "trauma_type_anyseqtbi_severe" ~ "TBI-severe",
                          term == "trauma_type_anyseqtrauma_non_tbi" ~ "Trauma-not TBI",
                          term == "prolonged_mec_vent:trauma_type_anyseqtbi_non_severe" ~ "PMV + TBI-non severe",
                          term == "prolonged_mec_vent:trauma_type_anyseqtbi_severe" ~ "PMV + TBI-severe",
                          term == "prolonged_mec_vent:trauma_type_anyseqtrauma_non_tbi" ~ "PMV + Trauma - no TBI",
                          term == "age" ~ "Age (years)",
                          term == "sexM" ~ "Sex (male)",
                          TRUE ~ term), 
         term = factor(term, levels = variable_order),
         adverse_protective = case_when(
           OR_lower > 1 & OR_upper > 1 ~ "Adverse",
           OR_lower < 1 & OR_upper < 1 ~ "Protective",
           TRUE ~ "Inconclusive"
    ),
    adverse_protective = factor(adverse_protective, levels = c("Adverse", "Protective", "Inconclusive"))) %>%
  filter(term != "Intercept")

# Save PMV's OR for this specific model 
or_deathyear_PMV_nontrauma_mimiciv <- or_deathyear_2_non_trauma[or_deathyear_2_non_trauma[,1]=="PMV", c(1,6:9)]
or_deathyear_PMV_nontrauma_mimiciv[, 1] <- "PMV for non-Trauma"

# Save OR table and print in console
write.csv(or_deathyear_2_non_trauma,'C:/Users/se_al/Documents/GitHub/mimiciv-mec-vent/data/mimic-iv/or_deathyear_PMV-nontrauma_mimiciv.csv')
htmlTable(or_deathyear_2_non_trauma[,c("term","OR","OR_lower","OR_upper")], caption = "Logistic Regression. Odds Ratio and Confidence Intervals for 1 Year-Mortality-associated Factors. MIMIC-IV Database")

# Export OR table as kable 
or_table <- or_deathyear_2_non_trauma %>%
  select(term, OR, OR_lower, OR_upper) %>%
  mutate(
    term = factor(term, levels = variable_order),
    OR_upper = ifelse(OR_upper <= 100, sprintf("%.2f", OR_upper), sprintf("%.2e", OR_upper))) %>%
  arrange(desc(term)) %>%
  kbl(caption = "Logistic Regression. Odds Ratio and Confidence Intervals for 1 Year-Mortality-associated Factors. MIMIC-IV Database" , align = "c") %>%
  kable_classic_2(full_width = F, html_font = "Cambria") %>%
  save_kable("C:/Users/se_al/Documents/GitHub/mimiciv-mec-vent/figures/mimic-iv/Odds_ratio/or_deathyear_PMV-nontrauma_mimiciv.png",
             zoom = 10)
 
# Build the Forest plot
ggplot(or_deathyear_2_non_trauma, 
       aes(x = OR, xmin = OR_lower, xmax = OR_upper, y = term)) +
  geom_point(size = 2, aes(color = adverse_protective)) +
  geom_errorbarh(height = 0.2, aes(color = adverse_protective)) +
  geom_vline(xintercept = 1, linetype = "dashed") +
  labs(x = "Odds Ratio", y = NULL, title = "Logistic Regression. Odds Ratio and Confidence Intervals\nfor 1 Year-Mortality-associated Factors. MIMIC-IV Database") +
  theme_minimal() +
  scale_color_manual(
    values = c("#c0392b", "#27ae60", "gray70"),
    labels = c("Adverse", "Protective", "Inconclusive"),
    name = "Effect on Outcome", 
    limits = adverse_protective_levels$adverse_protective) + #establishes limits of color scale
  scale_x_continuous(limits = c(0, 17)) +
  theme(
    plot.background = element_rect(fill = "white"),
    panel.grid.major.y = element_blank(),
    panel.grid.minor.y = element_blank(),
    plot.title = element_text(hjust = 0.5),
    legend.position = "top",
    axis.ticks = element_blank(),
    axis.text.x = element_text(color = "#2c3e50"),
    axis.text.y = element_text(color = "#2c3e50"
    ))

# Save the Forest plot as a PNG file
ggsave("C:/Users/se_al/Documents/GitHub/mimiciv-mec-vent/figures/mimic-iv/Forest_plot/fp_deathyear_PMV-nontrauma_mimiciv.png", width = 10, height = 4, dpi = 300)
```

## 1 Year-Mortality: Ref trauma_non_tbi

### Fitting the model

```{r}
# Recategorize tbi_severe as reference level in trauma_type_anyseq
final_dataset_MIMICIV_trauma_non_tbi <- final_dataset_MIMICIV %>%
  mutate(trauma_type_anyseq = as.factor(trauma_type_anyseq),
    trauma_type_anyseq = relevel(trauma_type_anyseq, ref = "trauma_non_tbi"))

print('Logistic Regression of mortality at 1 year')
print(Sys.time())
logreg_deathyear <- glm(
   death_year ~ prolonged_mec_vent * trauma_type_anyseq + age + sex + apsiii + charlson,
  data = final_dataset_MIMICIV_trauma_non_tbi,
  family = binomial())
print(Sys.time())
```

### Odds ratio and Forest plot

```{r}
# Extract Odds ratio
or_deathyear_1 <- extract_coef_pval_OR(logreg_deathyear)

# Order variables
variable_order <- rev(c(
  "Intercept", "Age (years)", "Sex (male)", "PMV", "TBI-severe", "Non Trauma", "TBI-non severe", "PMV + TBI-severe", "PMV + Non Trauma", "PMV + TBI-non severe"))

# Assign proper names to OR table
or_deathyear_2_trauma_non_tbi <- or_deathyear_1 %>% 
  mutate(term = case_when(term == "(Intercept)" ~ "Intercept",
                          term == "prolonged_mec_vent" ~ "PMV",
                          term == "trauma_type_anyseqtbi_non_severe" ~ "TBI-non severe",
                          term == "trauma_type_anyseqtbi_severe" ~ "TBI-severe",
                          term == "trauma_type_anyseqtrauma_non_tbi" ~ "Trauma-not TBI",
                          term == "trauma_type_anyseqnon_trauma" ~ "Non Trauma",
                          term == "prolonged_mec_vent:trauma_type_anyseqtbi_non_severe" ~ "PMV + TBI-non severe",
                          term == "prolonged_mec_vent:trauma_type_anyseqtbi_severe" ~ "PMV + TBI-severe",
                          term == "prolonged_mec_vent:trauma_type_anyseqtrauma_non_tbi" ~ "PMV + Trauma - no TBI",
                          term == "prolonged_mec_vent:trauma_type_anyseqnon_trauma" ~ "PMV + Non Trauma",
                          term == "age" ~ "Age (years)",
                          term == "sexM" ~ "Sex (male)",
                          TRUE ~ term), 
         term = factor(term, levels = variable_order),
         adverse_protective = case_when(
           OR_lower > 1 & OR_upper > 1 ~ "Adverse",
           OR_lower < 1 & OR_upper < 1 ~ "Protective",
           TRUE ~ "Inconclusive"
    ),
    adverse_protective = factor(adverse_protective, levels = c("Adverse", "Protective", "Inconclusive"))) %>%
  filter(term != "Intercept")

# Save PMV's OR for this specific model 
or_deathyear_PMV_traumanontbi_mimiciv <- or_deathyear_2_trauma_non_tbi[or_deathyear_2_trauma_non_tbi[,1]=="PMV", c(1,6:9)]
or_deathyear_PMV_traumanontbi_mimiciv[, 1] <- "PMV for Trauma not TBI"

# Save OR table and print in console
write.csv(or_deathyear_2_trauma_non_tbi,'C:/Users/se_al/Documents/GitHub/mimiciv-mec-vent/data/mimic-iv/or_deathyear_PMV-TraumanotTBI_mimiciv.csv')
htmlTable(or_deathyear_2_trauma_non_tbi[,c("term","OR","OR_lower","OR_upper")], caption = "Logistic Regression. Odds Ratio and Confidence Intervals for 1 Year-Mortality-associated Factors. MIMIC-IV Database")

# Export OR table as kable 
or_table <- or_deathyear_2_trauma_non_tbi %>%
  select(term, OR, OR_lower, OR_upper) %>%
  mutate(
    term = factor(term, levels = variable_order),
    OR_upper = ifelse(OR_upper <= 100, sprintf("%.2f", OR_upper), sprintf("%.2e", OR_upper))) %>%
  arrange(desc(term)) %>%
  kbl(caption = "Logistic Regression. Odds Ratio and Confidence Intervals for 1 Year-Mortality-associated Factors. MIMIC-IV Database" , align = "c") %>%
  kable_classic_2(full_width = F, html_font = "Cambria") %>%
  save_kable("C:/Users/se_al/Documents/GitHub/mimiciv-mec-vent/figures/mimic-iv/Odds_ratio/or_deathyear_PMV-TraumanotTBI_mimiciv.png",
             zoom = 10)
 
# Build the Forest plot
ggplot(or_deathyear_2_trauma_non_tbi, 
       aes(x = OR, xmin = OR_lower, xmax = OR_upper, y = term)) +
  geom_point(size = 2, aes(color = adverse_protective)) +
  geom_errorbarh(height = 0.2, aes(color = adverse_protective)) +
  geom_vline(xintercept = 1, linetype = "dashed") +
  labs(x = "Odds Ratio", y = NULL, title = "Logistic Regression. Odds Ratio and Confidence Intervals\nfor 1 Year-Mortality-associated Factors. MIMIC-IV Database") +
  theme_minimal() +
  scale_color_manual(
    values = c("#c0392b", "#27ae60", "gray70"),
    labels = c("Adverse", "Protective", "Inconclusive"),
    name = "Effect on Outcome", 
    limits = adverse_protective_levels$adverse_protective) + #establishes limits of color scale
  scale_x_continuous(limits = c(0, 13)) +
  theme(
    plot.background = element_rect(fill = "white"),
    panel.grid.major.y = element_blank(),
    panel.grid.minor.y = element_blank(),
    plot.title = element_text(hjust = 0.5),
    legend.position = "top",
    axis.ticks = element_blank(),
    axis.text.x = element_text(color = "#2c3e50"),
    axis.text.y = element_text(color = "#2c3e50"
    ))

# Save the Forest plot as a PNG file
ggsave("C:/Users/se_al/Documents/GitHub/mimiciv-mec-vent/figures/mimic-iv/Forest_plot/fp_deathyear_PMV-TraumanotTBI_mimiciv.png", width = 10, height = 4, dpi = 300)
```

## 1 Year-Mortality: Ref tbi_non_severe

### Fitting the model

```{r}
# Recategorize tbi_severe as reference level in trauma_type_anyseq
final_dataset_MIMICIV_tbi_non_severe <- final_dataset_MIMICIV %>%
  mutate(trauma_type_anyseq = as.factor(trauma_type_anyseq),
    trauma_type_anyseq = relevel(trauma_type_anyseq, ref = "tbi_non_severe"))

print('Logistic Regression of mortality at 1 year')
print(Sys.time())
logreg_deathyear <- glm(
   death_year ~ prolonged_mec_vent * trauma_type_anyseq + age + sex + apsiii + charlson,
  data = final_dataset_MIMICIV_tbi_non_severe,
  family = binomial())
print(Sys.time())
```

### Odds ratio and Forest plot

```{r}
# Extract Odds ratio
or_deathyear_1 <- extract_coef_pval_OR(logreg_deathyear)

# Order variables
variable_order <- rev(c(
  "Intercept", "Age (years)", "Sex (male)", "PMV", "TBI-severe", "Non Trauma", "Trauma-not TBI", "PMV + TBI-severe", "PMV + Non Trauma", "PMV + Trauma - no TBI"))

# Assign proper names to OR table
or_deathyear_2_tbi_non_severe <- or_deathyear_1 %>% 
  mutate(term = case_when(term == "(Intercept)" ~ "Intercept",
                          term == "prolonged_mec_vent" ~ "PMV",
                          term == "trauma_type_anyseqtbi_non_severe" ~ "TBI-non severe",
                          term == "trauma_type_anyseqtbi_severe" ~ "TBI-severe",
                          term == "trauma_type_anyseqtrauma_non_tbi" ~ "Trauma-not TBI",
                          term == "trauma_type_anyseqnon_trauma" ~ "Non Trauma",
                          term == "prolonged_mec_vent:trauma_type_anyseqtbi_non_severe" ~ "PMV + TBI-non severe",
                          term == "prolonged_mec_vent:trauma_type_anyseqtbi_severe" ~ "PMV + TBI-severe",
                          term == "prolonged_mec_vent:trauma_type_anyseqtrauma_non_tbi" ~ "PMV + Trauma - no TBI",
                          term == "prolonged_mec_vent:trauma_type_anyseqnon_trauma" ~ "PMV + Non Trauma",
                          term == "age" ~ "Age (years)",
                          term == "sexM" ~ "Sex (male)",
                          TRUE ~ term), 
         term = factor(term, levels = variable_order),
         adverse_protective = case_when(
           OR_lower > 1 & OR_upper > 1 ~ "Adverse",
           OR_lower < 1 & OR_upper < 1 ~ "Protective",
           TRUE ~ "Inconclusive"
    ),
    adverse_protective = factor(adverse_protective, levels = c("Adverse", "Protective", "Inconclusive"))) %>%
  filter(term != "Intercept")

# Save PMV's OR for this specific model 
or_deathyear_PMV_tbinonsevere_mimiciv <- or_deathyear_2_tbi_non_severe[or_deathyear_2_tbi_non_severe[,1]=="PMV", c(1,6:9)]
or_deathyear_PMV_tbinonsevere_mimiciv[, 1] <- "PMV for TBI non-severe"

# Save OR table and print in console
write.csv(or_deathyear_2_tbi_non_severe,'C:/Users/se_al/Documents/GitHub/mimiciv-mec-vent/data/mimic-iv/or_deathyear_PMV-TBInonsevere_mimiciv.csv')
htmlTable(or_deathyear_2_tbi_non_severe[,c("term","OR","OR_lower","OR_upper")], caption = "Logistic Regression. Odds Ratio and Confidence Intervals for 1 Year-Mortality-associated Factors. MIMIC-IV Database")

# Export OR table as kable 
or_table <- or_deathyear_2_tbi_non_severe %>%
  select(term, OR, OR_lower, OR_upper) %>%
  mutate(
    term = factor(term, levels = variable_order),
    OR_upper = ifelse(OR_upper <= 100, sprintf("%.2f", OR_upper), sprintf("%.2e", OR_upper))) %>%
  arrange(desc(term)) %>%
  kbl(caption = "Logistic Regression. Odds Ratio and Confidence Intervals for 1 Year-Mortality-associated Factors. MIMIC-IV Database" , align = "c") %>%
  kable_classic_2(full_width = F, html_font = "Cambria") %>%
  save_kable("C:/Users/se_al/Documents/GitHub/mimiciv-mec-vent/figures/mimic-iv/Odds_ratio/or_deathyear_PMV-TBInonsevere_mimiciv.png",
             zoom = 10)
 
# Build the Forest plot
ggplot(or_deathyear_2_tbi_non_severe, 
       aes(x = OR, xmin = OR_lower, xmax = OR_upper, y = term)) +
  geom_point(size = 2, aes(color = adverse_protective)) +
  geom_errorbarh(height = 0.2, aes(color = adverse_protective)) +
  geom_vline(xintercept = 1, linetype = "dashed") +
  labs(x = "Odds Ratio", y = NULL, title = "Logistic Regression. Odds Ratio and Confidence Intervals\nfor 1 Year-Mortality-associated Factors. MIMIC-IV Database") +
  theme_minimal() +
  scale_color_manual(
    values = c("#c0392b", "#27ae60", "gray70"),
    labels = c("Adverse", "Protective", "Inconclusive"),
    name = "Effect on Outcome", 
    limits = adverse_protective_levels$adverse_protective) + #establishes limits of color scale
  scale_x_continuous(limits = c(0, 13)) +
  theme(
    plot.background = element_rect(fill = "white"),
    panel.grid.major.y = element_blank(),
    panel.grid.minor.y = element_blank(),
    plot.title = element_text(hjust = 0.5),
    legend.position = "top",
    axis.ticks = element_blank(),
    axis.text.x = element_text(color = "#2c3e50"),
    axis.text.y = element_text(color = "#2c3e50"
    ))

# Save the Forest plot as a PNG file
ggsave("C:/Users/se_al/Documents/GitHub/mimiciv-mec-vent/figures/mimic-iv/Forest_plot/fp_deathyear_PMV-TBInonsevere_mimiciv.png", width = 10, height = 4, dpi = 300)
```

## 1 Year-Mortality: Ref tbi_severe

### Fitting the model

```{r}
# Recategorize tbi_severe as reference level in trauma_type_anyseq
final_dataset_MIMICIV_tbi_severe <- final_dataset_MIMICIV %>%
  mutate(trauma_type_anyseq = as.factor(trauma_type_anyseq),
    trauma_type_anyseq = relevel(trauma_type_anyseq, ref = "tbi_severe"))

print('Logistic Regression of mortality at 1 year')
print(Sys.time())
logreg_deathyear <- glm(
   death_year ~ prolonged_mec_vent * trauma_type_anyseq + age + sex + apsiii + charlson,
  data = final_dataset_MIMICIV_tbi_severe,
  family = binomial())
print(Sys.time())
```

### Odds ratio and Forest plot

```{r}
# Extract Odds ratio
or_deathyear_1 <- extract_coef_pval_OR(logreg_deathyear)

# Order variables
variable_order <- rev(c(
  "Intercept", "Age (years)", "Sex (male)", "PMV", "TBI-non severe", "Non Trauma", "Trauma-not TBI", "PMV + TBI-non severe", "PMV + Non Trauma", "PMV + Trauma - no TBI"))

# Assign proper names to OR table
or_deathyear_2_tbi_severe <- or_deathyear_1 %>% 
  mutate(term = case_when(term == "(Intercept)" ~ "Intercept",
                          term == "prolonged_mec_vent" ~ "PMV",
                          term == "trauma_type_anyseqtbi_non_severe" ~ "TBI-non severe",
                          term == "trauma_type_anyseqtbi_severe" ~ "TBI-severe",
                          term == "trauma_type_anyseqtrauma_non_tbi" ~ "Trauma-not TBI",
                          term == "trauma_type_anyseqnon_trauma" ~ "Non Trauma",
                          term == "prolonged_mec_vent:trauma_type_anyseqtbi_non_severe" ~ "PMV + TBI-non severe",
                          term == "prolonged_mec_vent:trauma_type_anyseqtbi_severe" ~ "PMV + TBI-severe",
                          term == "prolonged_mec_vent:trauma_type_anyseqtrauma_non_tbi" ~ "PMV + Trauma - no TBI",
                          term == "prolonged_mec_vent:trauma_type_anyseqnon_trauma" ~ "PMV + Non Trauma",
                          term == "age" ~ "Age (years)",
                          term == "sexM" ~ "Sex (male)",
                          TRUE ~ term), 
         term = factor(term, levels = variable_order),
         adverse_protective = case_when(
           OR_lower > 1 & OR_upper > 1 ~ "Adverse",
           OR_lower < 1 & OR_upper < 1 ~ "Protective",
           TRUE ~ "Inconclusive"
    ),
    adverse_protective = factor(adverse_protective, levels = c("Adverse", "Protective", "Inconclusive"))) %>%
  filter(term != "Intercept")

# Save PMV's OR for this specific model 
or_deathyear_PMV_tbisevere_mimiciv <- or_deathyear_2_tbi_severe[or_deathyear_2_tbi_severe[,1]=="PMV", c(1,6:9)]
or_deathyear_PMV_tbisevere_mimiciv[, 1] <- "PMV for TBI severe"

# Save OR table and print in console
write.csv(or_deathyear_2_tbi_severe,'C:/Users/se_al/Documents/GitHub/mimiciv-mec-vent/data/mimic-iv/or_deathyear_PMV-TBIsevere_mimiciv.csv')
htmlTable(or_deathyear_2_tbi_severe[,c("term","OR","OR_lower","OR_upper")], caption = "Logistic Regression. Odds Ratio and Confidence Intervals for 1 Year-Mortality-associated Factors. MIMIC-IV Database")

# Export OR table as kable 
or_table <- or_deathyear_2_tbi_severe %>%
  select(term, OR, OR_lower, OR_upper) %>%
  mutate(
    term = factor(term, levels = variable_order),
    OR_upper = ifelse(OR_upper <= 100, sprintf("%.2f", OR_upper), sprintf("%.2e", OR_upper))) %>%
  arrange(desc(term)) %>%
  kbl(caption = "Logistic Regression. Odds Ratio and Confidence Intervals for 1 Year-Mortality-associated Factors. MIMIC-IV Database" , align = "c") %>%
  kable_classic_2(full_width = F, html_font = "Cambria") %>%
  save_kable("C:/Users/se_al/Documents/GitHub/mimiciv-mec-vent/figures/mimic-iv/Odds_ratio/or_deathyear_PMV-TBIsevere_mimiciv.png",
             zoom = 10)
 
# Build the Forest plot
ggplot(or_deathyear_2_tbi_severe, 
       aes(x = OR, xmin = OR_lower, xmax = OR_upper, y = term)) +
  geom_point(size = 2, aes(color = adverse_protective)) +
  geom_errorbarh(height = 0.2, aes(color = adverse_protective)) +
  geom_vline(xintercept = 1, linetype = "dashed") +
  labs(x = "Odds Ratio", y = NULL, title = "Logistic Regression. Odds Ratio and Confidence Intervals\nfor 1 Year-Mortality-associated Factors. MIMIC-IV Database") +
  theme_minimal() +
  scale_color_manual(
    values = c("#c0392b", "#27ae60", "gray70"),
    labels = c("Adverse", "Protective", "Inconclusive"),
    name = "Effect on Outcome", 
    limits = adverse_protective_levels$adverse_protective) + #establishes limits of color scale
  scale_x_continuous(limits = c(0, 27)) +
  theme(
    plot.background = element_rect(fill = "white"),
    panel.grid.major.y = element_blank(),
    panel.grid.minor.y = element_blank(),
    plot.title = element_text(hjust = 0.5),
    legend.position = "top",
    axis.ticks = element_blank(),
    axis.text.x = element_text(color = "#2c3e50"),
    axis.text.y = element_text(color = "#2c3e50"
    ))

# Save the Forest plot as a PNG file
ggsave("C:/Users/se_al/Documents/GitHub/mimiciv-mec-vent/figures/mimic-iv/Forest_plot/fp_deathyear_PMV-TBIsevere_mimiciv.png", width = 10, height = 4, dpi = 300)
```



## Combined results for PMV's OR for different trauma subsets

```{r}
# Obtain combined table
MIMICIV_or_deathyear_PMV <- rbind(or_deathyear_PMV_nontrauma_mimiciv, or_deathyear_PMV_traumanontbi_mimiciv, or_deathyear_PMV_tbinonsevere_mimiciv, or_deathyear_PMV_tbisevere_mimiciv)

# Order variables
variable_order <- rev(c("Non Trauma", "non-TBI Trauma", "non-severe TBI", "severe TBI"))

# Assign proper names to OR table
MIMICIV_or_deathyear_PMV_2 <- MIMICIV_or_deathyear_PMV %>% 
  mutate(term = case_when(term == "(Intercept)" ~ "Intercept",
                          term == "PMV for Trauma not TBI" ~ "non-TBI Trauma",
                          term == "PMV for TBI non-severe" ~ "non-severe TBI",
                          term == "PMV for TBI severe" ~ "severe TBI",
                          term == "PMV for non-Trauma" ~ "Non Trauma",
                          TRUE ~ term), 
         term = factor(term, levels = variable_order),
         adverse_protective = case_when(
           OR_lower > 1 & OR_upper > 1 ~ "Adverse",
           OR_lower < 1 & OR_upper < 1 ~ "Protective",
           TRUE ~ "Inconclusive"
    ),
    adverse_protective = factor(adverse_protective, levels = c("Adverse", "Protective", "Inconclusive"))) %>%
  filter(term != "Intercept")

# Save OR table and print in console
write.csv(MIMICIV_or_deathyear_PMV_2,'C:/Users/se_al/Documents/GitHub/mimiciv-mec-vent/data/mimic-iv/or_deathyear_PMV_all-trauma_mimiciv.csv')
htmlTable(MIMICIV_or_deathyear_PMV_2[,c("term","OR","OR_lower","OR_upper")], caption = "Odds Ratio and Confidence Intervals for factors associated with 1 Year-Mortality. All types of trauma. MIMIC-IV Database")

# Export OR table as kable 
or_table <- MIMICIV_or_deathyear_PMV_2 %>%
  select(term, OR, OR_lower, OR_upper) %>%
  mutate(
    term = factor(term, levels = variable_order),
    OR_upper = ifelse(OR_upper <= 100, sprintf("%.2f", OR_upper), sprintf("%.2e", OR_upper))) %>%
  arrange(desc(term)) %>%
  kbl(caption = "Logistic Regression. Odds Ratio and Confidence Intervals for factors associated with 1 Year-Mortality. All types of trauma. MIMIC-IV Database" , align = "c") %>%
  kable_classic_2(full_width = F, html_font = "Cambria") %>%
  save_kable("C:/Users/se_al/Documents/GitHub/mimiciv-mec-vent/figures/mimic-iv/Odds_ratio/or_deathyear_PMV_all-trauma_mimiciv.png",
             zoom = 10)
 
# Build the Forest plot
fp_PMV_alltraumas_deathyear_mimiciv <- ggplot(MIMICIV_or_deathyear_PMV_2, 
       aes(x = OR, xmin = OR_lower, xmax = OR_upper, y = term)) +
  geom_point(size = 2, aes(color = adverse_protective)) +
  geom_errorbarh(height = 0.2, aes(color = adverse_protective)) +
  geom_vline(xintercept = 1, linetype = "dashed") +
  labs(x = "Odds Ratio", y = NULL, title = "Logistic Regression. Odds Ratio and Confidence Intervals\nfor factors associated with 1 Year-Mortality.\nAll types of trauma. MIMIC-IV Database") +
  theme_minimal() +
  scale_color_manual(
    values = c("#c0392b", "#27ae60", "gray70"),
    labels = c("Adverse", "Protective", "Inconclusive"),
    name = "Effect on Outcome", 
    limits = adverse_protective_levels$adverse_protective) + #establishes limits of color scale
  scale_x_continuous(limits = c(0, 4)) +
  theme(
    plot.background = element_rect(fill = "white"),
    panel.grid.major.y = element_blank(),
    panel.grid.minor.y = element_blank(),
    plot.title = element_text(hjust = 0.5),
    legend.position = "top",
    axis.ticks = element_blank(),
    axis.text.x = element_text(color = "#2c3e50"),
    axis.text.y = element_text(color = "#2c3e50"
    ))
fp_PMV_alltraumas_deathyear_mimiciv


# Save the Forest plot as a PNG file
ggsave("C:/Users/se_al/Documents/GitHub/mimiciv-mec-vent/figures/mimic-iv/Forest_plot/fp_deathyear_PMV_all-trauma_mimiciv.png", plot=fp_PMV_alltraumas_deathyear_mimiciv, width = 10, height = 4, dpi = 300)

```

# Final combined image of the project

```{r}
# Organize plots in a 2x2 layout
combined_plots <- grid.arrange(
  fp_PMV_alltraumas_hospdeath_mimiciv, fp_PMV_alltraumas_deathyear_mimiciv, fp_PMV_alltraumas_hospdeath_eicu,
  layout_matrix = rbind(c(1, 2), c(3, 4))
)

# Mostrar la imagen combinada
print(combined_plots)

```


