---
title: "03_modeling"
# output: html_document
---

# Environment

```{r}
library(skimr)
library(mgcv)
library(parallel)
library(parglm)
library(pROC)
library(ggplot2)
library(tibble)
library(dplyr)
library(feather)
library(broom)
library(htmlTable)
library(randomForest)
library(caret)
library(kableExtra)
library(magick)
library(gridExtra)
library(webshot2)


extract_coef_pval_OR <- function(model) {
  
  as.data.frame(tibble(term = names(model$coefficients),
                       estimate = model$coefficients,
                       std.error = sqrt(diag(vcov(model))),
                       statistic = model$coefficients / sqrt(diag(vcov(model))),
                       p.value = 2 * (1 - pnorm(abs(statistic))),
                       OR = round(exp(estimate),2),
                       OR_lower = round(exp(estimate - 1.96 * std.error),2),
                       OR_upper = round(exp(estimate + 1.96 * std.error),2)
  )
  )
} 
```

# Load File

```{r}
final_dataset_eICU <- readRDS('C:/Users/se_al/Documents/GitHub/mimiciv-mec-vent/data/eICU/final_dataset_eICU.rds')
```


# Logistic Regression with interaction: Hospital death

## Hospital Mortality: Ref non_trauma

### Fitting the model

```{r}
print('Logistic Regression of hospital mortality')
print(Sys.time())
logreg_hospdeath <- glm(
   inhospital_death ~ prolonged_mec_vent * trauma_type_anyseq + age + sex + aps + charlson + metastasis + hiv + liver_cirrhosis + stroke + renal_disease + diabetes_disease + cancer + leukemia_disease + lymphoma_disease + myocardial_infarction + chf + pvd + tia + dementia + copd + ctd + pud + liver_disease,
  data = final_dataset_eICU,
  family = binomial())
print(Sys.time())
```

### Odds ratio and Forest plot

```{r}
# Extract Odds ratio
or_hospdeath_1 <- extract_coef_pval_OR(logreg_hospdeath)

# Order variables
variable_order <- rev(c(
  "Intercept", "Age (years)", "Sex (male)", "PMV", "TBI-non severe", "TBI-severe", "Trauma-not TBI", "PMV + TBI-non severe", "PMV + TBI-severe", "PMV + Trauma - no TBI"))

# Assign proper names to OR table
or_hospdeath_2_non_trauma <- or_hospdeath_1 %>% 
  mutate(term = case_when(term == "(Intercept)" ~ "Intercept",
                          term == "prolonged_mec_vent" ~ "PMV",
                          term == "trauma_type_anyseqtbi_non_severe" ~ "TBI-non severe",
                          term == "trauma_type_anyseqtbi_severe" ~ "TBI-severe",
                          term == "trauma_type_anyseqtrauma_non_tbi" ~ "Trauma-not TBI",
                          term == "prolonged_mec_vent:trauma_type_anyseqtbi_non_severe" ~ "PMV + TBI-non severe",
                          term == "prolonged_mec_vent:trauma_type_anyseqtbi_severe" ~ "PMV + TBI-severe",
                          term == "prolonged_mec_vent:trauma_type_anyseqtrauma_non_tbi" ~ "PMV + Trauma - no TBI",
                          term == "age" ~ "Age (years)",
                          term == "sexMale" ~ "Sex (male)",
                          TRUE ~ term), 
         term = factor(term, levels = variable_order),
         adverse_protective = case_when(
           OR_lower > 1 & OR_upper > 1 ~ "Adverse",
           OR_lower < 1 & OR_upper < 1 ~ "Protective",
           TRUE ~ "Inconclusive"
    ),
    adverse_protective = factor(adverse_protective, levels = c("Adverse", "Protective", "Inconclusive"))) %>%
  filter(term != "Intercept")

# Save PMV's OR for this specific model 
or_hospdeath_PMV_nontrauma_eICU <- or_hospdeath_2_non_trauma[or_hospdeath_2_non_trauma[,1]=="PMV", c(1,6:9)]
or_hospdeath_PMV_nontrauma_eICU[, 1] <- "PMV for non-Trauma"

# Save OR table and print in console
write.csv(or_hospdeath_2_non_trauma,'C:/Users/se_al/Documents/GitHub/mimiciv-mec-vent/data/eICU/or_hospdeath_PMV-nontrauma_eICU.csv')
htmlTable(or_hospdeath_2_non_trauma[,c("term","OR","OR_lower","OR_upper")], caption = "Logistic Regression. Odds Ratio and Confidence Intervals for Hospital Mortality-associated Factors. eICU Database")

# # Export OR table as kable 
# or_table <- or_hospdeath_2_non_trauma %>%
#   select(term, OR, OR_lower, OR_upper) %>%
#   mutate(
#     term = factor(term, levels = variable_order),
#     OR_upper = ifelse(OR_upper <= 100, sprintf("%.2f", OR_upper), sprintf("%.2e", OR_upper))) %>%
#   arrange(desc(term)) %>%
#   kbl(caption = "Logistic Regression. Odds Ratio and Confidence Intervals for Hospital Mortality-associated Factors. eICU Database" , align = "c") %>%
#   kable_classic_2(full_width = F, html_font = "Cambria") %>%
#   save_kable("C:/Users/se_al/Documents/GitHub/mimiciv-mec-vent/figures/eICU/Odds_ratio/or_hospdeath_PMV-nontrauma_eICU.png",
#              zoom = 10)
 
# Build the Forest plot
ggplot(or_hospdeath_2_non_trauma, 
       aes(x = OR, xmin = OR_lower, xmax = OR_upper, y = term)) +
  geom_point(size = 2, aes(color = adverse_protective)) +
  geom_errorbarh(height = 0.2, aes(color = adverse_protective)) +
  geom_vline(xintercept = 1, linetype = "dashed") +
  labs(x = "Odds Ratio", y = NULL, title = "Logistic Regression. Odds Ratio and Confidence Intervals\nfor Hospital Mortality-associated Factors. eICU Database") +
  theme_minimal() +
  scale_color_manual(
    values = c("#c0392b", "#27ae60", "gray70"),
    labels = c("Adverse", "Protective", "Inconclusive"),
    name = "Effect on Outcome", 
    limits = adverse_protective_levels$adverse_protective) + #establishes limits of color scale
  scale_x_continuous(limits = c(0, 6)) +
  theme(
    plot.background = element_rect(fill = "white"),
    panel.grid.major.y = element_blank(),
    panel.grid.minor.y = element_blank(),
    plot.title = element_text(hjust = 0.5),
    legend.position = "top",
    axis.ticks = element_blank(),
    axis.text.x = element_text(color = "#2c3e50"),
    axis.text.y = element_text(color = "#2c3e50"
    ))

# Save the Forest plot as a PNG file
ggsave("C:/Users/se_al/Documents/GitHub/mimiciv-mec-vent/figures/eICU/Forest_plot/fp_hospdeath_PMV-nontrauma_eICU.png", width = 10, height = 4, dpi = 300)
```

## Hospital Mortality: Ref trauma_non_tbi

### Fitting the model

```{r}
# Recategorize tbi_severe as reference level in trauma_type_anyseq
final_dataset_eICU_trauma_non_tbi <- final_dataset_eICU %>%
  mutate(trauma_type_anyseq = as.factor(trauma_type_anyseq),
    trauma_type_anyseq = relevel(trauma_type_anyseq, ref = "trauma_non_tbi"))

print('Logistic Regression of hospital mortality')
print(Sys.time())
logreg_hospdeath <- glm(
   inhospital_death ~ prolonged_mec_vent * trauma_type_anyseq + age + sex + aps + charlson + metastasis + hiv + liver_cirrhosis + stroke + renal_disease + diabetes_disease + cancer + leukemia_disease + lymphoma_disease + myocardial_infarction + chf + pvd + tia + dementia + copd + ctd + pud + liver_disease,
  data = final_dataset_eICU_trauma_non_tbi,
  family = binomial())
print(Sys.time())
```

### Odds ratio and Forest plot

```{r}
# Extract Odds ratio
or_hospdeath_1 <- extract_coef_pval_OR(logreg_hospdeath)

# Order variables
variable_order <- rev(c(
  "Intercept", "Age (years)", "Sex (male)", "PMV", "TBI-severe", "Non Trauma", "TBI-non severe", "PMV + TBI-severe", "PMV + Non Trauma", "PMV + TBI-non severe"))

# Assign proper names to OR table
or_hospdeath_2_trauma_non_tbi <- or_hospdeath_1 %>% 
  mutate(term = case_when(term == "(Intercept)" ~ "Intercept",
                          term == "prolonged_mec_vent" ~ "PMV",
                          term == "trauma_type_anyseqtbi_non_severe" ~ "TBI-non severe",
                          term == "trauma_type_anyseqtbi_severe" ~ "TBI-severe",
                          term == "trauma_type_anyseqtrauma_non_tbi" ~ "Trauma-not TBI",
                          term == "trauma_type_anyseqnon_trauma" ~ "Non Trauma",
                          term == "prolonged_mec_vent:trauma_type_anyseqtbi_non_severe" ~ "PMV + TBI-non severe",
                          term == "prolonged_mec_vent:trauma_type_anyseqtbi_severe" ~ "PMV + TBI-severe",
                          term == "prolonged_mec_vent:trauma_type_anyseqtrauma_non_tbi" ~ "PMV + Trauma - no TBI",
                          term == "prolonged_mec_vent:trauma_type_anyseqnon_trauma" ~ "PMV + Non Trauma",
                          term == "age" ~ "Age (years)",
                          term == "sexMale" ~ "Sex (male)",
                          TRUE ~ term), 
         term = factor(term, levels = variable_order),
         adverse_protective = case_when(
           OR_lower > 1 & OR_upper > 1 ~ "Adverse",
           OR_lower < 1 & OR_upper < 1 ~ "Protective",
           TRUE ~ "Inconclusive"
    ),
    adverse_protective = factor(adverse_protective, levels = c("Adverse", "Protective", "Inconclusive"))) %>%
  filter(term != "Intercept")

# Save PMV's OR for this specific model 
or_hospdeath_PMV_traumanontbi_eICU <- or_hospdeath_2_trauma_non_tbi[or_hospdeath_2_trauma_non_tbi[,1]=="PMV", c(1,6:9)]
or_hospdeath_PMV_traumanontbi_eICU[, 1] <- "PMV for Trauma not TBI"

# Save OR table and print in console
write.csv(or_hospdeath_2_trauma_non_tbi,'C:/Users/se_al/Documents/GitHub/mimiciv-mec-vent/data/eICU/or_hospdeath_PMV-TraumanotTBI_eICU.csv')
htmlTable(or_hospdeath_2_trauma_non_tbi[,c("term","OR","OR_lower","OR_upper")], caption = "Logistic Regression. Odds Ratio and Confidence Intervals for Hospital Mortality-associated Factors. eICU Database")

# # Export OR table as kable 
# or_table <- or_hospdeath_2_trauma_non_tbi %>%
#   select(term, OR, OR_lower, OR_upper) %>%
#   mutate(
#     term = factor(term, levels = variable_order),
#     OR_upper = ifelse(OR_upper <= 100, sprintf("%.2f", OR_upper), sprintf("%.2e", OR_upper))) %>%
#   arrange(desc(term)) %>%
#   kbl(caption = "Logistic Regression. Odds Ratio and Confidence Intervals for Hospital Mortality-associated Factors. eICU Database" , align = "c") %>%
#   kable_classic_2(full_width = F, html_font = "Cambria") %>%
#   save_kable("C:/Users/se_al/Documents/GitHub/mimiciv-mec-vent/figures/eICU/Odds_ratio/or_hospdeath_PMV-TraumanotTBI_eICU.png",
#              zoom = 10)
 
# Build the Forest plot
ggplot(or_hospdeath_2_trauma_non_tbi, 
       aes(x = OR, xmin = OR_lower, xmax = OR_upper, y = term)) +
  geom_point(size = 2, aes(color = adverse_protective)) +
  geom_errorbarh(height = 0.2, aes(color = adverse_protective)) +
  geom_vline(xintercept = 1, linetype = "dashed") +
  labs(x = "Odds Ratio", y = NULL, title = "Logistic Regression. Odds Ratio and Confidence Intervals\nfor Hospital Mortality-associated Factors. eICU Database") +
  theme_minimal() +
  scale_color_manual(
    values = c("#c0392b", "#27ae60", "gray70"),
    labels = c("Adverse", "Protective", "Inconclusive"),
    name = "Effect on Outcome", 
    limits = adverse_protective_levels$adverse_protective) + #establishes limits of color scale
  scale_x_continuous(limits = c(0, 8)) +
  theme(
    plot.background = element_rect(fill = "white"),
    panel.grid.major.y = element_blank(),
    panel.grid.minor.y = element_blank(),
    plot.title = element_text(hjust = 0.5),
    legend.position = "top",
    axis.ticks = element_blank(),
    axis.text.x = element_text(color = "#2c3e50"),
    axis.text.y = element_text(color = "#2c3e50"
    ))

# Save the Forest plot as a PNG file
ggsave("C:/Users/se_al/Documents/GitHub/mimiciv-mec-vent/figures/eICU/Forest_plot/fp_hospdeath_PMV-TraumanotTBI_eICU.png", width = 10, height = 4, dpi = 300)
```

## Hospital Mortality: Ref tbi_non_severe

### Fitting the model

```{r}
# Recategorize tbi_severe as reference level in trauma_type_anyseq
final_dataset_eICU_tbi_non_severe <- final_dataset_eICU %>%
  mutate(trauma_type_anyseq = as.factor(trauma_type_anyseq),
    trauma_type_anyseq = relevel(trauma_type_anyseq, ref = "tbi_non_severe"))

print('Logistic Regression of hospital mortality')
print(Sys.time())
logreg_hospdeath <- glm(
   inhospital_death ~ prolonged_mec_vent * trauma_type_anyseq + age + sex + aps + charlson + metastasis + hiv + liver_cirrhosis + stroke + renal_disease + diabetes_disease + cancer + leukemia_disease + lymphoma_disease + myocardial_infarction + chf + pvd + tia + dementia + copd + ctd + pud + liver_disease,
  data = final_dataset_eICU_tbi_non_severe,
  family = binomial())
print(Sys.time())
```

### Odds ratio and Forest plot

```{r}
# Extract Odds ratio
or_hospdeath_1 <- extract_coef_pval_OR(logreg_hospdeath)

# Order variables
variable_order <- rev(c(
  "Intercept", "Age (years)", "Sex (male)", "PMV", "TBI-severe", "Non Trauma", "Trauma-not TBI", "PMV + TBI-severe", "PMV + Non Trauma", "PMV + Trauma - no TBI"))

# Assign proper names to OR table
or_hospdeath_2_tbi_non_severe <- or_hospdeath_1 %>% 
  mutate(term = case_when(term == "(Intercept)" ~ "Intercept",
                          term == "prolonged_mec_vent" ~ "PMV",
                          term == "trauma_type_anyseqtbi_non_severe" ~ "TBI-non severe",
                          term == "trauma_type_anyseqtbi_severe" ~ "TBI-severe",
                          term == "trauma_type_anyseqtrauma_non_tbi" ~ "Trauma-not TBI",
                          term == "trauma_type_anyseqnon_trauma" ~ "Non Trauma",
                          term == "prolonged_mec_vent:trauma_type_anyseqtbi_non_severe" ~ "PMV + TBI-non severe",
                          term == "prolonged_mec_vent:trauma_type_anyseqtbi_severe" ~ "PMV + TBI-severe",
                          term == "prolonged_mec_vent:trauma_type_anyseqtrauma_non_tbi" ~ "PMV + Trauma - no TBI",
                          term == "prolonged_mec_vent:trauma_type_anyseqnon_trauma" ~ "PMV + Non Trauma",
                          term == "age" ~ "Age (years)",
                          term == "sexMale" ~ "Sex (male)",
                          TRUE ~ term), 
         term = factor(term, levels = variable_order),
         adverse_protective = case_when(
           OR_lower > 1 & OR_upper > 1 ~ "Adverse",
           OR_lower < 1 & OR_upper < 1 ~ "Protective",
           TRUE ~ "Inconclusive"
    ),
    adverse_protective = factor(adverse_protective, levels = c("Adverse", "Protective", "Inconclusive"))) %>%
  filter(term != "Intercept")

# Save PMV's OR for this specific model 
or_hospdeath_PMV_tbinonsevere_eICU <- or_hospdeath_2_tbi_non_severe[or_hospdeath_2_tbi_non_severe[,1]=="PMV", c(1,6:9)]
or_hospdeath_PMV_tbinonsevere_eICU[, 1] <- "PMV for TBI non-severe"

# Save OR table and print in console
write.csv(or_hospdeath_2_tbi_non_severe,'C:/Users/se_al/Documents/GitHub/mimiciv-mec-vent/data/eICU/or_hospdeath_PMV-TBInonsevere_eICU.csv')
htmlTable(or_hospdeath_2_tbi_non_severe[,c("term","OR","OR_lower","OR_upper")], caption = "Logistic Regression. Odds Ratio and Confidence Intervals for Hospital Mortality-associated Factors. eICU Database")

# # Export OR table as kable 
# or_table <- or_hospdeath_2_tbi_non_severe %>%
#   select(term, OR, OR_lower, OR_upper) %>%
#   mutate(
#     term = factor(term, levels = variable_order),
#     OR_upper = ifelse(OR_upper <= 100, sprintf("%.2f", OR_upper), sprintf("%.2e", OR_upper))) %>%
#   arrange(desc(term)) %>%
#   kbl(caption = "Logistic Regression. Odds Ratio and Confidence Intervals for Hospital Mortality-associated Factors. eICU Database" , align = "c") %>%
#   kable_classic_2(full_width = F, html_font = "Cambria") %>%
#   save_kable("C:/Users/se_al/Documents/GitHub/mimiciv-mec-vent/figures/eICU/Odds_ratio/or_hospdeath_PMV-TBInonsevere_eICU.png",
#              zoom = 10)
 
# Build the Forest plot
ggplot(or_hospdeath_2_tbi_non_severe, 
       aes(x = OR, xmin = OR_lower, xmax = OR_upper, y = term)) +
  geom_point(size = 2, aes(color = adverse_protective)) +
  geom_errorbarh(height = 0.2, aes(color = adverse_protective)) +
  geom_vline(xintercept = 1, linetype = "dashed") +
  labs(x = "Odds Ratio", y = NULL, title = "Logistic Regression. Odds Ratio and Confidence Intervals\nfor Hospital Mortality-associated Factors. eICU Database") +
  theme_minimal() +
  scale_color_manual(
    values = c("#c0392b", "#27ae60", "gray70"),
    labels = c("Adverse", "Protective", "Inconclusive"),
    name = "Effect on Outcome", 
    limits = adverse_protective_levels$adverse_protective) + #establishes limits of color scale
  scale_x_continuous(limits = c(0, 9)) +
  theme(
    plot.background = element_rect(fill = "white"),
    panel.grid.major.y = element_blank(),
    panel.grid.minor.y = element_blank(),
    plot.title = element_text(hjust = 0.5),
    legend.position = "top",
    axis.ticks = element_blank(),
    axis.text.x = element_text(color = "#2c3e50"),
    axis.text.y = element_text(color = "#2c3e50"
    ))

# Save the Forest plot as a PNG file
ggsave("C:/Users/se_al/Documents/GitHub/mimiciv-mec-vent/figures/eICU/Forest_plot/fp_hospdeath_PMV-TBInonsevere_eICU.png", width = 10, height = 4, dpi = 300)
```

## Hospital Mortality: Ref tbi_severe

### Fitting the model

```{r}
# Recategorize tbi_severe as reference level in trauma_type_anyseq
final_dataset_eICU_tbi_severe <- final_dataset_eICU %>%
  mutate(trauma_type_anyseq = as.factor(trauma_type_anyseq),
    trauma_type_anyseq = relevel(trauma_type_anyseq, ref = "tbi_severe"))

print('Logistic Regression of hospital mortality')
print(Sys.time())
logreg_hospdeath <- glm(
   inhospital_death ~ prolonged_mec_vent * trauma_type_anyseq + age + sex + aps + charlson + metastasis + hiv + liver_cirrhosis + stroke + renal_disease + diabetes_disease + cancer + leukemia_disease + lymphoma_disease + myocardial_infarction + chf + pvd + tia + dementia + copd + ctd + pud + liver_disease,
  data = final_dataset_eICU_tbi_severe,
  family = binomial())
print(Sys.time())
```

### Odds ratio and Forest plot

```{r}
# Extract Odds ratio
or_hospdeath_1 <- extract_coef_pval_OR(logreg_hospdeath)

# Order variables
variable_order <- rev(c(
  "Intercept", "Age (years)", "Sex (male)", "PMV", "TBI-non severe", "Non Trauma", "Trauma-not TBI", "PMV + TBI-non severe", "PMV + Non Trauma", "PMV + Trauma - no TBI"))

# Assign proper names to OR table
or_hospdeath_2_tbi_severe <- or_hospdeath_1 %>% 
  mutate(term = case_when(term == "(Intercept)" ~ "Intercept",
                          term == "prolonged_mec_vent" ~ "PMV",
                          term == "trauma_type_anyseqtbi_non_severe" ~ "TBI-non severe",
                          term == "trauma_type_anyseqtbi_severe" ~ "TBI-severe",
                          term == "trauma_type_anyseqtrauma_non_tbi" ~ "Trauma-not TBI",
                          term == "trauma_type_anyseqnon_trauma" ~ "Non Trauma",
                          term == "prolonged_mec_vent:trauma_type_anyseqtbi_non_severe" ~ "PMV + TBI-non severe",
                          term == "prolonged_mec_vent:trauma_type_anyseqtbi_severe" ~ "PMV + TBI-severe",
                          term == "prolonged_mec_vent:trauma_type_anyseqtrauma_non_tbi" ~ "PMV + Trauma - no TBI",
                          term == "prolonged_mec_vent:trauma_type_anyseqnon_trauma" ~ "PMV + Non Trauma",
                          term == "age" ~ "Age (years)",
                          term == "sexMale" ~ "Sex (male)",
                          TRUE ~ term), 
         term = factor(term, levels = variable_order),
         adverse_protective = case_when(
           OR_lower > 1 & OR_upper > 1 ~ "Adverse",
           OR_lower < 1 & OR_upper < 1 ~ "Protective",
           TRUE ~ "Inconclusive"
    ),
    adverse_protective = factor(adverse_protective, levels = c("Adverse", "Protective", "Inconclusive"))) %>%
  filter(term != "Intercept")

# Save PMV's OR for this specific model 
or_hospdeath_PMV_tbisevere_eICU <- or_hospdeath_2_tbi_severe[or_hospdeath_2_tbi_severe[,1]=="PMV", c(1,6:9)]
or_hospdeath_PMV_tbisevere_eICU[, 1] <- "PMV for TBI severe"

# Save OR table and print in console
write.csv(or_hospdeath_2_tbi_severe,'C:/Users/se_al/Documents/GitHub/mimiciv-mec-vent/data/eICU/or_hospdeath_PMV-TBIsevere_eICU.csv')
htmlTable(or_hospdeath_2_tbi_severe[,c("term","OR","OR_lower","OR_upper")], caption = "Logistic Regression. Odds Ratio and Confidence Intervals for Hospital Mortality-associated Factors. eICU Database")

# # Export OR table as kable 
# or_table <- or_hospdeath_2_tbi_severe %>%
#   select(term, OR, OR_lower, OR_upper) %>%
#   mutate(
#     term = factor(term, levels = variable_order),
#     OR_upper = ifelse(OR_upper <= 100, sprintf("%.2f", OR_upper), sprintf("%.2e", OR_upper))) %>%
#   arrange(desc(term)) %>%
#   kbl(caption = "Logistic Regression. Odds Ratio and Confidence Intervals for Hospital Mortality-associated Factors. eICU Database" , align = "c") %>%
#   kable_classic_2(full_width = F, html_font = "Cambria") %>%
#   save_kable("C:/Users/se_al/Documents/GitHub/mimiciv-mec-vent/figures/eICU/Odds_ratio/or_hospdeath_PMV-TBIsevere_eICU.png",
#              zoom = 10)
 
# Build the Forest plot
ggplot(or_hospdeath_2_tbi_severe, 
       aes(x = OR, xmin = OR_lower, xmax = OR_upper, y = term)) +
  geom_point(size = 2, aes(color = adverse_protective)) +
  geom_errorbarh(height = 0.2, aes(color = adverse_protective)) +
  geom_vline(xintercept = 1, linetype = "dashed") +
  labs(x = "Odds Ratio", y = NULL, title = "Logistic Regression. Odds Ratio and Confidence Intervals\nfor Hospital Mortality-associated Factors. eICU Database") +
  theme_minimal() +
  scale_color_manual(
    values = c("#c0392b", "#27ae60", "gray70"),
    labels = c("Adverse", "Protective", "Inconclusive"),
    name = "Effect on Outcome", 
    limits = adverse_protective_levels$adverse_protective) + #establishes limits of color scale
  scale_x_continuous(limits = c(0, 14)) +
  theme(
    plot.background = element_rect(fill = "white"),
    panel.grid.major.y = element_blank(),
    panel.grid.minor.y = element_blank(),
    plot.title = element_text(hjust = 0.5),
    legend.position = "top",
    axis.ticks = element_blank(),
    axis.text.x = element_text(color = "#2c3e50"),
    axis.text.y = element_text(color = "#2c3e50"
    ))

# Save the Forest plot as a PNG file
ggsave("C:/Users/se_al/Documents/GitHub/mimiciv-mec-vent/figures/eICU/Forest_plot/fp_hospdeath_PMV-TBIsevere_eICU.png", width = 10, height = 4, dpi = 300)
```

## Combined results for PMV's OR for different trauma subsets

```{r}
# Obtain combined table
eICU_or_hospdeath_PMV <- rbind(or_hospdeath_PMV_nontrauma_eICU, or_hospdeath_PMV_traumanontbi_eICU, or_hospdeath_PMV_tbinonsevere_eICU, or_hospdeath_PMV_tbisevere_eICU)

# Order variables
variable_order <- rev(c("Non Trauma", "non-TBI Trauma", "non-severe TBI", "severe TBI"))

# Assign proper names to OR table
eICU_or_hospdeath_PMV_2 <- eICU_or_hospdeath_PMV %>% 
  mutate(term = case_when(term == "(Intercept)" ~ "Intercept",
                          term == "PMV for Trauma not TBI" ~ "non-TBI Trauma",
                          term == "PMV for TBI non-severe" ~ "non-severe TBI",
                          term == "PMV for TBI severe" ~ "severe TBI",
                          term == "PMV for non-Trauma" ~ "Non Trauma",
                          TRUE ~ term), 
         term = factor(term, levels = variable_order),
         adverse_protective = case_when(
           OR_lower > 1 & OR_upper > 1 ~ "Adverse",
           OR_lower < 1 & OR_upper < 1 ~ "Protective",
           TRUE ~ "Inconclusive"
    ),
    adverse_protective = factor(adverse_protective, levels = c("Adverse", "Protective", "Inconclusive"))) %>%
  filter(term != "Intercept")

# Save OR table and print in console
write.csv(eICU_or_hospdeath_PMV_2,'C:/Users/se_al/Documents/GitHub/mimiciv-mec-vent/data/eICU/or_hospdeath_PMV_all-trauma_eICU.csv')
htmlTable(eICU_or_hospdeath_PMV_2[,c("term","OR","OR_lower","OR_upper")], caption = "Odds Ratio and Confidence Intervals for factors associated with Hospital Mortality. All types of trauma. eICU Database")

# # Export OR table as kable 
# or_table <- eICU_or_hospdeath_PMV_2 %>%
#   select(term, OR, OR_lower, OR_upper) %>%
#   mutate(
#     term = factor(term, levels = variable_order),
#     OR_upper = ifelse(OR_upper <= 100, sprintf("%.2f", OR_upper), sprintf("%.2e", OR_upper))) %>%
#   arrange(desc(term)) %>%
#   kbl(caption = "Logistic Regression. Odds Ratio and Confidence Intervals for factors associated with Hospital Mortality. All types of trauma. eICU Database" , align = "c") %>%
#   kable_classic_2(full_width = F, html_font = "Cambria") %>%
#   save_kable("C:/Users/se_al/Documents/GitHub/mimiciv-mec-vent/figures/eICU/Odds_ratio/or_hospdeath_PMV_all-trauma_eICU.png", zoom = 10)
 
# Build the Forest plot
fp_PMV_alltraumas_hospdeath_eICU <- ggplot(eICU_or_hospdeath_PMV_2, 
       aes(x = OR, xmin = OR_lower, xmax = OR_upper, y = term)) +
  geom_point(size = 2, aes(color = adverse_protective)) +
  geom_errorbarh(height = 0.2, aes(color = adverse_protective)) +
  geom_vline(xintercept = 1, linetype = "dashed") +
  labs(x = "Odds Ratio", y = NULL, title = "Logistic Regression. Odds Ratio and Confidence Intervals\nfor factors associated with Hospital Mortality.\nAll types of trauma. eICU Database") +
  theme_minimal() +
  scale_color_manual(
    values = c("#c0392b", "#27ae60", "gray70"),
    labels = c("Adverse", "Protective", "Inconclusive"),
    name = "Effect on Outcome", 
    limits = adverse_protective_levels$adverse_protective) + #establishes limits of color scale
  scale_x_continuous(limits = c(0, 6)) +
  theme(
    plot.background = element_rect(fill = "white"),
    panel.grid.major.y = element_blank(),
    panel.grid.minor.y = element_blank(),
    plot.title = element_text(hjust = 0.5),
    legend.position = "top",
    axis.ticks = element_blank(),
    axis.text.x = element_text(color = "#2c3e50"),
    axis.text.y = element_text(color = "#2c3e50"
    ))
fp_PMV_alltraumas_hospdeath_eICU


# Save the Forest plot as a PNG file
ggsave("C:/Users/se_al/Documents/GitHub/mimiciv-mec-vent/figures/eICU/Forest_plot/fp_hospdeath_PMV_all-trauma_eICU.png", plot=fp_PMV_alltraumas_hospdeath_eICU, width = 10, height = 4, dpi = 300)

```

