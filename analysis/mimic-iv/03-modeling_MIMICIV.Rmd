---
title: "03_modeling"
# output: html_document
---

# Environment

```{r}
library(skimr)
library(mgcv)
library(parallel)
library(parglm)
library(pROC)
library(ggplot2)
library(tibble)
library(dplyr)
library(feather)
library(broom)
library(htmlTable)
library(randomForest)
library(caret)
library(kableExtra)

# metric performance
precision <- function(matrix) {
  # true positive
  tp <- matrix[2, 2]
  # false positive
  fp <- matrix[1, 2]
  return (tp / (tp + fp))
}
recall <- function(matrix) {
  # true positive
  tp <- matrix[2, 2]
  # false positive
  fn <- matrix[2, 1]
  return (tp / (tp + fn))
}
extract_coef_pval_OR <- function(model) {
  
  as.data.frame(tibble(term = names(model$coefficients),
                       estimate = model$coefficients,
                       std.error = sqrt(diag(vcov(model))),
                       statistic = model$coefficients / sqrt(diag(vcov(model))),
                       p.value = 2 * (1 - pnorm(abs(statistic))),
                       OR = round(exp(estimate),2),
                       OR_lower = round(exp(estimate - 1.96 * std.error),2),
                       OR_upper = round(exp(estimate + 1.96 * std.error),2)
  )
  )
} 
```

# Load File

```{r}
final_dataset_MIMICIV <- read.csv('C:/Users/se_al/Documents/GitHub/mimiciv-mec-vent/data/mimic-iv/final_dataset_MIMICIV.csv')
```


# Logistic Regression: Death at 30 days

## Hospital Mortality: PMV

### Fitting the model

```{r}
print('Logistic Regression of hospital mortality')
print(Sys.time())
logreg_hospdeath <- glm(
   inhospital_death ~ age + sex + prolonged_mec_vent + apsiii + charlson,
  data = final_dataset_MIMICIV,
  family = binomial())
print(Sys.time())
```

### Odds ratio and Forest plot

```{r}
# Extract Odds ratio
or_hospdeath_1 <- extract_coef_pval_OR(logreg_hospdeath)

# Order variables
variable_order <- rev(c(
  "Intercept", "Age (years)", "Sex (male)", "TBI as any diagnostic order", "Severe TBI as any diagnostics", "Traumatism as any diagnostic order", "Consecutive days with >6 hour ventilation", "PMV > consecutive 7 days", "PMV > consecutive 14 days", "PMV > consecutive 21 days", "MV for 96h + traqueostomy", "PMV - Prolonged Mechanical Ventilation"))

# Assign proper names to OR table
or_hospdeath_2 <- or_hospdeath_1 %>% 
  mutate(term = case_when(term == "(Intercept)" ~ "Intercept",
                          term == "age" ~ "Age (years)",
                           term == "sexM" ~ "Sex (male)",
                           term == "prolonged_mec_vent" ~ "PMV - Prolonged Mechanical Ventilation",
                          TRUE ~ term), 
         term = factor(term, levels = variable_order),
         adverse_protective = case_when(
           OR_lower > 1 & OR_upper > 1 ~ "Adverse",
           OR_lower < 1 & OR_upper < 1 ~ "Protective",
           TRUE ~ "Inconclusive"
    ),
    adverse_protective = factor(adverse_protective, levels = c("Adverse", "Protective", "Inconclusive"))) %>%
  filter(term != "Intercept")

# Save OR table and print in console
write.csv(or_hospdeath_2,'C:/Users/se_al/Documents/GitHub/mimiciv-mec-vent/data/mimic-iv/or_hospdeath_PMV_mimiciv.csv')
htmlTable(or_hospdeath_2[,c("term","OR","OR_lower","OR_upper")], caption = "Logistic Regression. Odds Ratio and Confidence Intervals for Hospital Mortality-associated Factors. MIMIC-IV Database")

# Export OR table as kable 
or_table <- or_hospdeath_2 %>%
  select(term, OR, OR_lower, OR_upper) %>%
  mutate(
    term = factor(term, levels = variable_order),
    OR_upper = ifelse(OR_upper <= 100, sprintf("%.2f", OR_upper), sprintf("%.2e", OR_upper))) %>%
  arrange(desc(term)) %>%
  kbl(caption = "Logistic Regression. Odds Ratio and Confidence Intervals for Hospital Mortality-associated Factors. MIMIC-IV Database" , align = "c") %>%
  kable_classic_2(full_width = F, html_font = "Cambria") %>%
  save_kable("C:/Users/se_al/Documents/GitHub/mimiciv-mec-vent/figures/mimic-iv/Odds_ratio/or_hospdeath_PMV_mimiciv.png",
             zoom = 10)
 
# Build the Forest plot
ggplot(or_hospdeath_2, 
       aes(x = OR, xmin = OR_lower, xmax = OR_upper, y = term)) +
  geom_point(size = 2, aes(color = adverse_protective)) +
  geom_errorbarh(height = 0.2, aes(color = adverse_protective)) +
  geom_vline(xintercept = 1, linetype = "dashed") +
  labs(x = "Odds Ratio", y = NULL, title = "Logistic Regression. Odds Ratio and Confidence Intervals\nfor Hospital Mortality-associated Factors. MIMIC-IV Database") +
  theme_minimal() +
  scale_color_manual(
    values = c("#c0392b", "#27ae60", "gray70"),
    labels = c("Adverse", "Protective", "Inconclusive"),
    name = "Effect on Outcome") +
  scale_x_continuous(limits = c(0, 5)) +
  theme(
    plot.background = element_rect(fill = "white"),
    panel.grid.major.y = element_blank(),
    panel.grid.minor.y = element_blank(),
    plot.title = element_text(hjust = 0.5),
    legend.position = "top",
    axis.ticks = element_blank(),
    axis.text.x = element_text(color = "#2c3e50"),
    axis.text.y = element_text(color = "#2c3e50"
    ))

# Save the Forest plot as a PNG file
ggsave("C:/Users/se_al/Documents/GitHub/mimiciv-mec-vent/figures/mimic-iv/Forest_plot/fp_hospdeath_PMV_mimiciv.png", width = 10, height = 4, dpi = 300)
```
## Hospital Mortality: Trauma types

### Fitting the model

```{r}
print('Logistic Regression of hospital mortality')
print(Sys.time())
logreg_hospdeath <- glm(
   inhospital_death ~ age + sex + trauma_type_anyseq + apsiii + charlson,
  data = final_dataset_MIMICIV,
  family = binomial())
print(Sys.time())
```

### Odds ratio and Forest plot

```{r}
# Extract Odds ratio
or_hospdeath_1 <- extract_coef_pval_OR(logreg_hospdeath)

# Order variables
variable_order <- rev(c(
  "Intercept", "Age (years)", "Sex (male)", "TBI - non severe", "TBI - severe", "Trauma-not TBI"))

# Assign proper names to OR table
or_hospdeath_2 <- or_hospdeath_1 %>% 
  mutate(term = case_when(term == "(Intercept)" ~ "Intercept",
                          term == "age" ~ "Age (years)",
                          term == "sexM" ~ "Sex (male)",
                          term == "trauma_type_anyseqtbi_non_severe" ~ "TBI - non severe",
                          term == "trauma_type_anyseqtbi_severe" ~ "TBI - severe",
                          term == "trauma_type_anyseqtrauma_non_tbi" ~ "Trauma-not TBI",
                          TRUE ~ term), 
         term = factor(term, levels = variable_order),
         adverse_protective = case_when(
           OR_lower > 1 & OR_upper > 1 ~ "Adverse",
           OR_lower < 1 & OR_upper < 1 ~ "Protective",
           TRUE ~ "Inconclusive"
    ),
    adverse_protective = factor(adverse_protective, levels = c("Adverse", "Protective", "Inconclusive"))) %>%
  filter(term != "Intercept")

# Save OR table and print in console
write.csv(or_hospdeath_2,'C:/Users/se_al/Documents/GitHub/mimiciv-mec-vent/data/mimic-iv/or_hospdeath_TBI_mimiciv.csv')
htmlTable(or_hospdeath_2[,c("term","OR","OR_lower","OR_upper")], caption = "Logistic Regression. Odds Ratio and Confidence Intervals for Hospital Mortality-associated Factors. MIMIC-IV Database")

# Export OR table as kable 
or_table <- or_hospdeath_2 %>%
  select(term, OR, OR_lower, OR_upper) %>%
  mutate(
    term = factor(term, levels = variable_order),
    OR_upper = ifelse(OR_upper <= 100, sprintf("%.2f", OR_upper), sprintf("%.2e", OR_upper))) %>%
  arrange(desc(term)) %>%
  kbl(caption = "Logistic Regression. Odds Ratio and Confidence Intervals for Hospital Mortality-associated Factors. MIMIC-IV Database" , align = "c") %>%
  kable_classic_2(full_width = F, html_font = "Cambria") %>%
  save_kable("C:/Users/se_al/Documents/GitHub/mimiciv-mec-vent/figures/mimic-iv/Odds_ratio/or_hospdeath_TBI_mimiciv.png",
             zoom = 10)
 
# Build the Forest plot
ggplot(or_hospdeath_2, 
       aes(x = OR, xmin = OR_lower, xmax = OR_upper, y = term)) +
  geom_point(size = 2, aes(color = adverse_protective)) +
  geom_errorbarh(height = 0.2, aes(color = adverse_protective)) +
  geom_vline(xintercept = 1, linetype = "dashed") +
  labs(x = "Odds Ratio", y = NULL, title = "Logistic Regression. Odds Ratio and Confidence Intervals\nfor Hospital Mortality-associated Factors. MIMIC-IV Database") +
  theme_minimal() +
  scale_color_manual(
    values = c("#c0392b", "#27ae60", "gray70"),
    labels = c("Adverse", "Protective", "Inconclusive"),
    name = "Effect on Outcome") +
  scale_x_continuous(limits = c(0, 12)) +
  theme(
    plot.background = element_rect(fill = "white"),
    panel.grid.major.y = element_blank(),
    panel.grid.minor.y = element_blank(),
    plot.title = element_text(hjust = 0.5),
    legend.position = "top",
    axis.ticks = element_blank(),
    axis.text.x = element_text(color = "#2c3e50"),
    axis.text.y = element_text(color = "#2c3e50"
    ))

# Save the Forest plot as a PNG file
ggsave("C:/Users/se_al/Documents/GitHub/mimiciv-mec-vent/figures/mimic-iv/Forest_plot/fp_hospdeath_TBI_mimiciv.png", width = 10, height = 4, dpi = 300)
```

# Logistic Regression with interaction: Death at 30 days

## Hospital Mortality: PMV and trauma types

### Fitting the model

```{r}
print('Logistic Regression of hospital mortality')
print(Sys.time())
logreg_hospdeath <- glm(
   inhospital_death ~ prolonged_mec_vent * trauma_type_anyseq + age + sex + apsiii + charlson,
  data = final_dataset_MIMICIV,
  family = binomial())
print(Sys.time())
```

### Odds ratio and Forest plot

```{r}
# Extract Odds ratio
or_hospdeath_1 <- extract_coef_pval_OR(logreg_hospdeath)

# Order variables
variable_order <- rev(c(
  "Intercept", "Age (years)", "Sex (male)", "PMV", "TBI-non severe", "TBI-severe", "Trauma-not TBI", "PMV + TBI-non severe", "PMV + TBI-severe", "PMV + Trauma - no TBI"))

# Assign proper names to OR table
or_hospdeath_2 <- or_hospdeath_1 %>% 
  mutate(term = case_when(term == "(Intercept)" ~ "Intercept",
                          term == "prolonged_mec_vent" ~ "PMV",
                          term == "trauma_type_anyseqtbi_non_severe" ~ "TBI-non severe",
                          term == "trauma_type_anyseqtbi_severe" ~ "TBI-severe",
                          term == "trauma_type_anyseqtrauma_non_tbi" ~ "Trauma-not TBI",
                          term == "prolonged_mec_vent:trauma_type_anyseqtbi_non_severe" ~ "PMV + TBI-non severe",
                          term == "prolonged_mec_vent:trauma_type_anyseqtbi_severe" ~ "PMV + TBI-severe",
                          term == "prolonged_mec_vent:trauma_type_anyseqtrauma_non_tbi" ~ "PMV + Trauma - no TBI",
                          term == "age" ~ "Age (years)",
                          term == "sexM" ~ "Sex (male)",
                          TRUE ~ term), 
         term = factor(term, levels = variable_order),
         adverse_protective = case_when(
           OR_lower > 1 & OR_upper > 1 ~ "Adverse",
           OR_lower < 1 & OR_upper < 1 ~ "Protective",
           TRUE ~ "Inconclusive"
    ),
    adverse_protective = factor(adverse_protective, levels = c("Adverse", "Protective", "Inconclusive"))) %>%
  filter(term != "Intercept")

# Save OR table and print in console
write.csv(or_hospdeath_2,'C:/Users/se_al/Documents/GitHub/mimiciv-mec-vent/data/mimic-iv/or_hospdeath_PMV-TBI_mimiciv.csv')
htmlTable(or_hospdeath_2[,c("term","OR","OR_lower","OR_upper")], caption = "Logistic Regression. Odds Ratio and Confidence Intervals for Hospital Mortality-associated Factors. MIMIC-IV Database")

# Export OR table as kable 
or_table <- or_hospdeath_2 %>%
  select(term, OR, OR_lower, OR_upper) %>%
  mutate(
    term = factor(term, levels = variable_order),
    OR_upper = ifelse(OR_upper <= 100, sprintf("%.2f", OR_upper), sprintf("%.2e", OR_upper))) %>%
  arrange(desc(term)) %>%
  kbl(caption = "Logistic Regression. Odds Ratio and Confidence Intervals for Hospital Mortality-associated Factors. MIMIC-IV Database" , align = "c") %>%
  kable_classic_2(full_width = F, html_font = "Cambria") %>%
  save_kable("C:/Users/se_al/Documents/GitHub/mimiciv-mec-vent/figures/mimic-iv/Odds_ratio/or_hospdeath_PMV-TBI_mimiciv.png",
             zoom = 10)
 
# Build the Forest plot
ggplot(or_hospdeath_2, 
       aes(x = OR, xmin = OR_lower, xmax = OR_upper, y = term)) +
  geom_point(size = 2, aes(color = adverse_protective)) +
  geom_errorbarh(height = 0.2, aes(color = adverse_protective)) +
  geom_vline(xintercept = 1, linetype = "dashed") +
  labs(x = "Odds Ratio", y = NULL, title = "Logistic Regression. Odds Ratio and Confidence Intervals\nfor Hospital Mortality-associated Factors. MIMIC-IV Database") +
  theme_minimal() +
  scale_color_manual(
    values = c("#c0392b", "#27ae60", "gray70"),
    labels = c("Adverse", "Protective", "Inconclusive"),
    name = "Effect on Outcome") +
  scale_x_continuous(limits = c(0, 13)) +
  theme(
    plot.background = element_rect(fill = "white"),
    panel.grid.major.y = element_blank(),
    panel.grid.minor.y = element_blank(),
    plot.title = element_text(hjust = 0.5),
    legend.position = "top",
    axis.ticks = element_blank(),
    axis.text.x = element_text(color = "#2c3e50"),
    axis.text.y = element_text(color = "#2c3e50"
    ))

# Save the Forest plot as a PNG file
ggsave("C:/Users/se_al/Documents/GitHub/mimiciv-mec-vent/figures/mimic-iv/Forest_plot/fp_hospdeath_PMV-TBI_mimiciv.png", width = 10, height = 4, dpi = 300)
```

# Interaction of PMV and Trauma types: Death at 30 days

```{r}
print('Logistic Regression of hospital mortality')
print(Sys.time())
logreg_hospdeath <- glm(
   inhospital_death ~ prolonged_mec_vent * trauma_type_anyseq + age + sex + apsiii + charlson,
  data = final_dataset_MIMICIV,
  family = binomial())
print(Sys.time())

# Print the model summary
print('Model summary of logistic regression model with interaction term between PMV and trauma type for hospital death')
summary(logreg_hospdeath)

# Perform an analysis of variance (ANOVA) to test the significance of the interaction
anova(logreg_hospdeath, test = "Chisq")

print('If the interaction is significant, we can proceed with post-hoc analyses to explore the nature of the interaction')

# Plot the interaction effect
ggplot(final_dataset_MIMICIV, aes(x = prolonged_mec_vent, y = inhospital_death, color = factor(trauma_type_anyseq))) +
  geom_point() +
  geom_smooth(method = "glm", method.args = list(family = "binomial"), se = FALSE) +
  labs(x = "Prolonged Mechanical Ventilation", y = "Hospital Mortality", color = "Type of Trauma", title = "Interaction Effect of PMV and Trauma types on Hospital Death. MIMIC-IV Database") +
  theme_minimal()

# Save the plot as a PNG file
ggsave("C:/Users/se_al/Documents/GitHub/mimiciv-mec-vent/figures/mimic-iv/Forest_plot/interactionplot_PMV-TBI_hospdeath_mimiciv.png", width = 6, height = 4, dpi = 300)

```

# Logistic Regression: Death at year

## Hospital Mortality: PMV

### Fitting the model

```{r}
print('Logistic Regression of hospital mortality')
print(Sys.time())
logreg_deathyear <- glm(
   death_year ~ age + sex + prolonged_mec_vent + apsiii + charlson,
  data = final_dataset_MIMICIV,
  family = binomial())
print(Sys.time())
```

### Odds ratio and Forest plot

```{r}
# Extract Odds ratio
or_deathyear_1 <- extract_coef_pval_OR(logreg_deathyear)

# Order variables
variable_order <- rev(c(
  "Intercept", "Age (years)", "Sex (male)", "TBI as any diagnostic order", "Severe TBI as any diagnostics", "Traumatism as any diagnostic order", "Consecutive days with >6 hour ventilation", "PMV > consecutive 7 days", "PMV > consecutive 14 days", "PMV > consecutive 21 days", "MV for 96h + traqueostomy", "PMV - Prolonged Mechanical Ventilation"))

# Assign proper names to OR table
or_deathyear_2 <- or_deathyear_1 %>% 
  mutate(term = case_when(term == "(Intercept)" ~ "Intercept",
                          term == "age" ~ "Age (years)",
                           term == "sexM" ~ "Sex (male)",
                           term == "prolonged_mec_vent" ~ "PMV - Prolonged Mechanical Ventilation",
                          TRUE ~ term), 
         term = factor(term, levels = variable_order),
         adverse_protective = case_when(
           OR_lower > 1 & OR_upper > 1 ~ "Adverse",
           OR_lower < 1 & OR_upper < 1 ~ "Protective",
           TRUE ~ "Inconclusive"
    ),
    adverse_protective = factor(adverse_protective, levels = c("Adverse", "Protective", "Inconclusive"))) %>%
  filter(term != "Intercept")

# Save OR table and print in console
write.csv(or_deathyear_2,'C:/Users/se_al/Documents/GitHub/mimiciv-mec-vent/data/mimic-iv/or_deathyear_PMV_mimiciv.csv')
htmlTable(or_deathyear_2[,c("term","OR","OR_lower","OR_upper")], caption = "Logistic Regression. Odds Ratio and Confidence Intervals for factors associated with death at year. MIMIC-IV Database")

# Export OR table as kable 
or_table <- or_deathyear_2 %>%
  select(term, OR, OR_lower, OR_upper) %>%
  mutate(
    term = factor(term, levels = variable_order),
    OR_upper = ifelse(OR_upper <= 100, sprintf("%.2f", OR_upper), sprintf("%.2e", OR_upper))) %>%
  arrange(desc(term)) %>%
  kbl(caption = "Logistic Regression. Odds Ratio and Confidence Intervals for factors associated with death at year. MIMIC-IV Database" , align = "c") %>%
  kable_classic_2(full_width = F, html_font = "Cambria") %>%
  save_kable("C:/Users/se_al/Documents/GitHub/mimiciv-mec-vent/figures/mimic-iv/Odds_ratio/or_deathyear_PMV_mimiciv.png",
             zoom = 10)
 
# Build the Forest plot
ggplot(or_deathyear_2, 
       aes(x = OR, xmin = OR_lower, xmax = OR_upper, y = term)) +
  geom_point(size = 2, aes(color = adverse_protective)) +
  geom_errorbarh(height = 0.2, aes(color = adverse_protective)) +
  geom_vline(xintercept = 1, linetype = "dashed") +
  labs(x = "Odds Ratio", y = NULL, title = "Logistic Regression. Odds Ratio and Confidence Intervals\nfor factors associated with death at year. MIMIC-IV Database") +
  theme_minimal() +
  scale_color_manual(
    values = c("#c0392b", "#27ae60", "gray70"),
    labels = c("Adverse", "Protective", "Inconclusive"),
    name = "Effect on Outcome") +
  scale_x_continuous(limits = c(0, 5)) +
  theme(
    plot.background = element_rect(fill = "white"),
    panel.grid.major.y = element_blank(),
    panel.grid.minor.y = element_blank(),
    plot.title = element_text(hjust = 0.5),
    legend.position = "top",
    axis.ticks = element_blank(),
    axis.text.x = element_text(color = "#2c3e50"),
    axis.text.y = element_text(color = "#2c3e50"
    ))

# Save the Forest plot as a PNG file
ggsave("C:/Users/se_al/Documents/GitHub/mimiciv-mec-vent/figures/mimic-iv/Forest_plot/fp_deathyear_PMV_mimiciv.png", width = 10, height = 4, dpi = 300)
```

## Hospital Mortality: Trauma types

### Fitting the model

```{r}
print('Logistic Regression of hospital mortality')
print(Sys.time())
logreg_deathyear <- glm(
   death_year ~ age + sex + trauma_type_anyseq + apsiii + charlson,
  data = final_dataset_MIMICIV,
  family = binomial())
print(Sys.time())
```

### Odds ratio and Forest plot

```{r}
# Extract Odds ratio
or_deathyear_1 <- extract_coef_pval_OR(logreg_deathyear)

# Order variables
variable_order <- rev(c(
  "Intercept", "Age (years)", "Sex (male)", "TBI - non severe", "TBI - severe", "Trauma-not TBI"))

# Assign proper names to OR table
or_deathyear_2 <- or_deathyear_1 %>% 
  mutate(term = case_when(term == "(Intercept)" ~ "Intercept",
                          term == "age" ~ "Age (years)",
                          term == "sexM" ~ "Sex (male)",
                          term == "trauma_type_anyseqtbi_non_severe" ~ "TBI - non severe",
                          term == "trauma_type_anyseqtbi_severe" ~ "TBI - severe",
                          term == "trauma_type_anyseqtrauma_non_tbi" ~ "Trauma-not TBI",
                          TRUE ~ term), 
         term = factor(term, levels = variable_order),
         adverse_protective = case_when(
           OR_lower > 1 & OR_upper > 1 ~ "Adverse",
           OR_lower < 1 & OR_upper < 1 ~ "Protective",
           TRUE ~ "Inconclusive"
    ),
    adverse_protective = factor(adverse_protective, levels = c("Adverse", "Protective", "Inconclusive"))) %>%
  filter(term != "Intercept")

# Save OR table and print in console
write.csv(or_deathyear_2,'C:/Users/se_al/Documents/GitHub/mimiciv-mec-vent/data/mimic-iv/or_deathyear_TBI_mimiciv.csv')
htmlTable(or_deathyear_2[,c("term","OR","OR_lower","OR_upper")], caption = "Logistic Regression. Odds Ratio and Confidence Intervals for factors associated with death at year. MIMIC-IV Database")

# Export OR table as kable 
or_table <- or_deathyear_2 %>%
  select(term, OR, OR_lower, OR_upper) %>%
  mutate(
    term = factor(term, levels = variable_order),
    OR_upper = ifelse(OR_upper <= 100, sprintf("%.2f", OR_upper), sprintf("%.2e", OR_upper))) %>%
  arrange(desc(term)) %>%
  kbl(caption = "Logistic Regression. Odds Ratio and Confidence Intervals for factors associated with death at year. MIMIC-IV Database" , align = "c") %>%
  kable_classic_2(full_width = F, html_font = "Cambria") %>%
  save_kable("C:/Users/se_al/Documents/GitHub/mimiciv-mec-vent/figures/mimic-iv/Odds_ratio/or_deathyear_TBI_mimiciv.png",
             zoom = 10)
 
# Build the Forest plot
ggplot(or_deathyear_2, 
       aes(x = OR, xmin = OR_lower, xmax = OR_upper, y = term)) +
  geom_point(size = 2, aes(color = adverse_protective)) +
  geom_errorbarh(height = 0.2, aes(color = adverse_protective)) +
  geom_vline(xintercept = 1, linetype = "dashed") +
  labs(x = "Odds Ratio", y = NULL, title = "Logistic Regression. Odds Ratio and Confidence Intervals\nfor factors associated with death at year. MIMIC-IV Database") +
  theme_minimal() +
  scale_color_manual(
    values = c("#c0392b", "#27ae60", "gray70"),
    labels = c("Adverse", "Protective", "Inconclusive"),
    name = "Effect on Outcome") +
  scale_x_continuous(limits = c(0, 12)) +
  theme(
    plot.background = element_rect(fill = "white"),
    panel.grid.major.y = element_blank(),
    panel.grid.minor.y = element_blank(),
    plot.title = element_text(hjust = 0.5),
    legend.position = "top",
    axis.ticks = element_blank(),
    axis.text.x = element_text(color = "#2c3e50"),
    axis.text.y = element_text(color = "#2c3e50"
    ))

# Save the Forest plot as a PNG file
ggsave("C:/Users/se_al/Documents/GitHub/mimiciv-mec-vent/figures/mimic-iv/Forest_plot/fp_deathyear_TBI_mimiciv.png", width = 10, height = 4, dpi = 300)
```

# Logistic Regression with interaction: Death at year

## Hospital Mortality: PMV and trauma types

### Fitting the model

```{r}
print('Logistic Regression of hospital mortality')
print(Sys.time())
logreg_deathyear <- glm(
   death_year ~ prolonged_mec_vent * trauma_type_anyseq + age + sex + apsiii + charlson,
  data = final_dataset_MIMICIV,
  family = binomial())
print(Sys.time())
```

### Odds ratio and Forest plot

```{r}
# Extract Odds ratio
or_deathyear_1 <- extract_coef_pval_OR(logreg_deathyear)

# Order variables
variable_order <- rev(c(
  "Intercept", "Age (years)", "Sex (male)", "PMV", "TBI-non severe", "TBI-severe", "Trauma-not TBI", "PMV + TBI-non severe", "PMV + TBI-severe", "PMV + Trauma - no TBI"))

# Assign proper names to OR table
or_deathyear_2 <- or_deathyear_1 %>% 
  mutate(term = case_when(term == "(Intercept)" ~ "Intercept",
                          term == "prolonged_mec_vent" ~ "PMV",
                          term == "trauma_type_anyseqtbi_non_severe" ~ "TBI-non severe",
                          term == "trauma_type_anyseqtbi_severe" ~ "TBI-severe",
                          term == "trauma_type_anyseqtrauma_non_tbi" ~ "Trauma-not TBI",
                          term == "prolonged_mec_vent:trauma_type_anyseqtbi_non_severe" ~ "PMV + TBI-non severe",
                          term == "prolonged_mec_vent:trauma_type_anyseqtbi_severe" ~ "PMV + TBI-severe",
                          term == "prolonged_mec_vent:trauma_type_anyseqtrauma_non_tbi" ~ "PMV + Trauma - no TBI",
                          term == "age" ~ "Age (years)",
                          term == "sexM" ~ "Sex (male)",
                          TRUE ~ term), 
         term = factor(term, levels = variable_order),
         adverse_protective = case_when(
           OR_lower > 1 & OR_upper > 1 ~ "Adverse",
           OR_lower < 1 & OR_upper < 1 ~ "Protective",
           TRUE ~ "Inconclusive"
    ),
    adverse_protective = factor(adverse_protective, levels = c("Adverse", "Protective", "Inconclusive"))) %>%
  filter(term != "Intercept")

# Save OR table and print in console
write.csv(or_deathyear_2,'C:/Users/se_al/Documents/GitHub/mimiciv-mec-vent/data/mimic-iv/or_deathyear_PMV-TBI_mimiciv.csv')
htmlTable(or_deathyear_2[,c("term","OR","OR_lower","OR_upper")], caption = "Logistic Regression. Odds Ratio and Confidence Intervals for factors associated with death at year. MIMIC-IV Database. MIMIC-IV Database")

# Export OR table as kable 
or_table <- or_deathyear_2 %>%
  select(term, OR, OR_lower, OR_upper) %>%
  mutate(
    term = factor(term, levels = variable_order),
    OR_upper = ifelse(OR_upper <= 100, sprintf("%.2f", OR_upper), sprintf("%.2e", OR_upper))) %>%
  arrange(desc(term)) %>%
  kbl(caption = "Logistic Regression. Odds Ratio and Confidence Intervals for factors associated with death at year. MIMIC-IV Database" , align = "c") %>%
  kable_classic_2(full_width = F, html_font = "Cambria") %>%
  save_kable("C:/Users/se_al/Documents/GitHub/mimiciv-mec-vent/figures/mimic-iv/Odds_ratio/or_deathyear_PMV-TBI_mimiciv.png",
             zoom = 10)
 
# Build the Forest plot
ggplot(or_deathyear_2, 
       aes(x = OR, xmin = OR_lower, xmax = OR_upper, y = term)) +
  geom_point(size = 2, aes(color = adverse_protective)) +
  geom_errorbarh(height = 0.2, aes(color = adverse_protective)) +
  geom_vline(xintercept = 1, linetype = "dashed") +
  labs(x = "Odds Ratio", y = NULL, title = "Logistic Regression. Odds Ratio and Confidence Intervals\nfor factors associated with death at year. MIMIC-IV Database") +
  theme_minimal() +
  scale_color_manual(
    values = c("#c0392b", "#27ae60", "gray70"),
    labels = c("Adverse", "Protective", "Inconclusive"),
    name = "Effect on Outcome") +
  scale_x_continuous(limits = c(0, 13)) +
  theme(
    plot.background = element_rect(fill = "white"),
    panel.grid.major.y = element_blank(),
    panel.grid.minor.y = element_blank(),
    plot.title = element_text(hjust = 0.5),
    legend.position = "top",
    axis.ticks = element_blank(),
    axis.text.x = element_text(color = "#2c3e50"),
    axis.text.y = element_text(color = "#2c3e50"
    ))

# Save the Forest plot as a PNG file
ggsave("C:/Users/se_al/Documents/GitHub/mimiciv-mec-vent/figures/mimic-iv/Forest_plot/fp_deathyear_PMV-TBI_mimiciv.png", width = 10, height = 4, dpi = 300)
```

# Interaction of PMV and Trauma types: Death at year

```{r}
print('Logistic Regression of mortality at 1 year')
print(Sys.time())
logreg_deathyear <- glm(
   death_year ~ prolonged_mec_vent * trauma_type_anyseq + age + sex + apsiii + charlson,
  data = final_dataset_MIMICIV,
  family = binomial())
print(Sys.time())

# Print the model summary
print('Model summary of logistic regression model with interaction term between PMV and trauma type for death at year')
summary(logreg_deathyear)

# Perform an analysis of variance (ANOVA) to test the significance of the interaction
anova(logreg_deathyear, test = "Chisq")

print('If the interaction is significant, we can proceed with post-hoc analyses to explore the nature of the interaction')

# Plot the interaction effect
ggplot(final_dataset_MIMICIV, aes(x = prolonged_mec_vent, y = death_year, color = factor(trauma_type_anyseq))) +
  geom_point() +
  geom_smooth(method = "glm", method.args = list(family = "binomial"), se = FALSE) +
  labs(x = "Prolonged Mechanical Ventilation", y = "Mortality at 1 year", color = "Type of Trauma", title = "Interaction Effect of PMV and Trauma types on Death at year. MIMIC-IV Database") +
  theme_minimal()

# Save the plot as a PNG file
ggsave("C:/Users/se_al/Documents/GitHub/mimiciv-mec-vent/figures/mimic-iv/Forest_plot/interactionplot_PMV-TBI_deathyear_mimiciv.png", width = 6, height = 4, dpi = 300)

```

# Correlation between TBI and age
```{r}
# Calculate the point-biserial correlation
correlation_tbi_age <- cor.test(final_dataset_MIMICIV$tbi_severe_anyseq, final_dataset_MIMICIV$age)

# Print the correlation coefficient and p-value
cat("Point-biserial correlation coefficient:", correlation_tbi_age$estimate, "\n")
cat("p-value:", correlation_tbi_age$p.value, "\n")

# Check if the correlation is significant
if (correlation_tbi_age$p.value < 0.05) {
  cat("The correlation is significant.\n")
} else {
  cat("The correlation is not significant.\n")
}

```

