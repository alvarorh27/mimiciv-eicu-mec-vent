---
title: "03_modeling"
# output: html_document
---

# Environment

```{r}
library(skimr)
library(mgcv)
library(parallel)
library(parglm)
library(pROC)
library(ggplot2)
library(tibble)
library(dplyr)
library(feather)
library(broom)
library(htmlTable)
library(randomForest)
library(caret)
library(kableExtra)

# metric performance
precision <- function(matrix) {
  # true positive
  tp <- matrix[2, 2]
  # false positive
  fp <- matrix[1, 2]
  return (tp / (tp + fp))
}
recall <- function(matrix) {
  # true positive
  tp <- matrix[2, 2]
  # false positive
  fn <- matrix[2, 1]
  return (tp / (tp + fn))
}
extract_coef_pval_OR <- function(model) {
  
  as.data.frame(tibble(term = names(model$coefficients),
                       estimate = model$coefficients,
                       std.error = sqrt(diag(vcov(model))),
                       statistic = model$coefficients / sqrt(diag(vcov(model))),
                       p.value = 2 * (1 - pnorm(abs(statistic))),
                       OR = round(exp(estimate),2),
                       OR_lower = round(exp(estimate - 1.96 * std.error),2),
                       OR_upper = round(exp(estimate + 1.96 * std.error),2)
  )
  )
} 
```

# Load File

```{r}
final_dataset_eICU <- read.csv('C:/Users/se_al/Documents/GitHub/mimiciv-mec-vent/data/eICU/final_dataset_eICU.csv')

```


# Logistic Regression

## Hospital Mortality: PMV

### Fitting the model

```{r}
print('Logistic Regression of hospital mortality')
print(Sys.time())
logreg_hospdeath <- glm(
   inhospital_death ~ age + sex + prolonged_mec_vent + aps + charlson + metastasis + hiv + liver_cirrhosis + stroke + renal_disease + diabetes_disease + cancer + leukemia_disease + lymphoma_disease + myocardial_infarction + chf + pvd + tia + dementia + copd + ctd + pud + liver_disease,
  data = final_dataset_eICU,
  family = binomial())
print(Sys.time())
```

### Odds ratio and Forest plot

```{r}
# Extract Odds ratio
or_hospdeath_1 <- extract_coef_pval_OR(logreg_hospdeath)

# Order variables
variable_order <- rev(c(
  "Intercept", "Age (years)", "Sex (male)", "PMV - Prolonged Mechanical Ventilation"))

# Assign proper names to OR table
or_hospdeath_2 <- or_hospdeath_1 %>% 
  mutate(term = case_when(term == "(Intercept)" ~ "Intercept",
                          term == "age" ~ "Age (years)",
                           term == "sexMale" ~ "Sex (male)",
                           term == "prolonged_mec_vent" ~ "PMV - Prolonged Mechanical Ventilation",
                          TRUE ~ term), 
         term = factor(term, levels = variable_order),
         adverse_protective = case_when(
           OR_lower > 1 & OR_upper > 1 ~ "Adverse",
           OR_lower < 1 & OR_upper < 1 ~ "Protective",
           OR_lower <= 1 & OR_upper >= 1 ~ "Inconclusive"
           ),
    adverse_protective = factor(adverse_protective, levels = c("Adverse", "Protective", "Inconclusive"))) %>%
  filter(term != "Intercept")

# Save OR table and print in console
write.csv(or_hospdeath_2,'C:/Users/se_al/Documents/GitHub/mimiciv-mec-vent/data/eICU/or_hospdeath_PMV_eicu.csv')
htmlTable(or_hospdeath_2[,c("term","OR","OR_lower","OR_upper")], caption = "Logistic Regression. Odds Ratio and Confidence Intervals for Hospital Mortality-associated Factors. eICU Database")

# Export OR table as kable 
or_table <- or_hospdeath_2 %>%
  select(term, OR, OR_lower, OR_upper) %>%
  mutate(
    term = factor(term, levels = variable_order),
    OR_upper = ifelse(OR_upper <= 100, sprintf("%.2f", OR_upper), sprintf("%.2e", OR_upper))) %>%
  arrange(desc(term)) %>%
  kbl(caption = "Logistic Regression. Odds Ratio and Confidence Intervals for Hospital Mortality-associated Factors. eICU Database" , align = "c") %>%
  kable_classic_2(full_width = F, html_font = "Cambria") %>%
  save_kable("C:/Users/se_al/Documents/GitHub/mimiciv-mec-vent/figures/eICU/Odds_ratio/or_hospdeath_PMV_eicu.png", zoom = 10)

# Create a data frame with all possible levels for adverse-protective-inconclusive variable
adverse_protective_levels <- data.frame(adverse_protective = c("Adverse", "Protective", "Inconclusive"))

# Build the Forest plot
ggplot(or_hospdeath_2, 
       aes(x = OR, xmin = OR_lower, xmax = OR_upper, y = term)) +
  geom_point(size = 2, aes(color = adverse_protective)) +
  geom_errorbarh(height = 0.2, aes(color = adverse_protective)) +
  geom_vline(xintercept = 1, linetype = "dashed") +
  labs(x = "Odds Ratio", y = NULL, title = "Logistic Regression. Odds Ratio and Confidence Intervals\nfor Hospital Mortality-associated Factors. eICU Database") +
  theme_minimal() +
  scale_color_manual(
    values = c("#c0392b", "#27ae60", "gray70"),
    labels = c("Adverse", "Protective", "Inconclusive"),
    name = "Effect on Outcome",
    limits = adverse_protective_levels$adverse_protective) + #establishes limits of color scale
  scale_x_continuous(limits = c(0.5, 2)) +
  theme(
    plot.background = element_rect(fill = "white"),
    panel.grid.major.y = element_blank(),
    panel.grid.minor.y = element_blank(),
    plot.title = element_text(hjust = 0.5),
    legend.position = "top",
    axis.ticks = element_blank(),
    axis.text.x = element_text(color = "#2c3e50"),
    axis.text.y = element_text(color = "#2c3e50"
    ))

# Save the Forest plot as a PNG file
ggsave("C:/Users/se_al/Documents/GitHub/mimiciv-mec-vent/figures/eICU/Forest_plot/fp_hospdeath_PMV_eicu.png", width = 10, height = 4, dpi = 300)
```
## Hospital Mortality: Trauma types

### Fitting the model

```{r}
print('Logistic Regression of hospital mortality')
print(Sys.time())
logreg_hospdeath <- glm(
   inhospital_death ~ age + sex + trauma_type_anyseq + aps + charlson + metastasis + hiv + liver_cirrhosis + stroke + renal_disease + diabetes_disease + cancer + leukemia_disease + lymphoma_disease + myocardial_infarction + chf + pvd + tia + dementia + copd + ctd + pud + liver_disease,
  data = final_dataset_eICU,
  family = binomial())
print(Sys.time())
```

### Odds ratio and Forest plot

```{r}
# Extract Odds ratio
or_hospdeath_1 <- extract_coef_pval_OR(logreg_hospdeath)

# Order variables
variable_order <- rev(c(
  "Intercept", "Age (years)", "Sex (male)", "TBI - non severe", "TBI - severe", "Trauma-not TBI"))

# Assign proper names to OR table
or_hospdeath_2 <- or_hospdeath_1 %>% 
  mutate(term = case_when(term == "(Intercept)" ~ "Intercept",
                          term == "age" ~ "Age (years)",
                          term == "sexMale" ~ "Sex (male)",
                          term == "trauma_type_anyseqtbi_non_severe" ~ "TBI - non severe",
                          term == "trauma_type_anyseqtbi_severe" ~ "TBI - severe",
                          term == "trauma_type_anyseqtrauma_non_tbi" ~ "Trauma-not TBI",
                          TRUE ~ term), 
         term = factor(term, levels = variable_order),
         adverse_protective = case_when(
           OR_lower > 1 & OR_upper > 1 ~ "Adverse",
           OR_lower < 1 & OR_upper < 1 ~ "Protective",
           TRUE ~ "Inconclusive"
    ),
    adverse_protective = factor(adverse_protective, levels = c("Adverse", "Protective", "Inconclusive"))) %>%
  filter(term != "Intercept")

# Save OR table and print in console
write.csv(or_hospdeath_2,'C:/Users/se_al/Documents/GitHub/mimiciv-mec-vent/data/eICU/or_hospdeath_TBI_eicu.csv')
htmlTable(or_hospdeath_2[,c("term","OR","OR_lower","OR_upper")], caption = "Logistic Regression. Odds Ratio and Confidence Intervals for Hospital Mortality-associated Factors. eICU Database")

# Export OR table as kable 
or_table <- or_hospdeath_2 %>%
  select(term, OR, OR_lower, OR_upper) %>%
  mutate(
    term = factor(term, levels = variable_order),
    OR_upper = ifelse(OR_upper <= 100, sprintf("%.2f", OR_upper), sprintf("%.2e", OR_upper))) %>%
  arrange(desc(term)) %>%
  kbl(caption = "Logistic Regression. Odds Ratio and Confidence Intervals for Hospital Mortality-associated Factors. eICU Database" , align = "c") %>%
  kable_classic_2(full_width = F, html_font = "Cambria") %>%
  save_kable("C:/Users/se_al/Documents/GitHub/mimiciv-mec-vent/figures/eICU/Odds_ratio/or_hospdeath_TBI_eicu.png",
             zoom = 10)
 
# Build the Forest plot
ggplot(or_hospdeath_2, 
       aes(x = OR, xmin = OR_lower, xmax = OR_upper, y = term)) +
  geom_point(size = 2, aes(color = adverse_protective)) +
  geom_errorbarh(height = 0.2, aes(color = adverse_protective)) +
  geom_vline(xintercept = 1, linetype = "dashed") +
  labs(x = "Odds Ratio", y = NULL, title = "Logistic Regression. Odds Ratio and Confidence Intervals\nfor Hospital Mortality-associated Factors. eICU Database") +
  theme_minimal() +
  scale_color_manual(
    values = c("#c0392b", "#27ae60", "gray70"),
    labels = c("Adverse", "Protective", "Inconclusive"),
    name = "Effect on Outcome") +
  scale_x_continuous(limits = c(0, 12)) +
  theme(
    plot.background = element_rect(fill = "white"),
    panel.grid.major.y = element_blank(),
    panel.grid.minor.y = element_blank(),
    plot.title = element_text(hjust = 0.5),
    legend.position = "top",
    axis.ticks = element_blank(),
    axis.text.x = element_text(color = "#2c3e50"),
    axis.text.y = element_text(color = "#2c3e50"
    ))

# Save the Forest plot as a PNG file
ggsave("C:/Users/se_al/Documents/GitHub/mimiciv-mec-vent/figures/eICU/Forest_plot/fp_hospdeath_TBI_eicu.png", width = 10, height = 4, dpi = 300)
```

# Logistic Regression with interaction

## Hospital Mortality: PMV and trauma types

### Fitting the model

```{r}
print('Logistic Regression of hospital mortality')
print(Sys.time())
logreg_hospdeath <- glm(
   inhospital_death ~ prolonged_mec_vent * trauma_type_anyseq + age + sex + aps + charlson + metastasis + hiv + liver_cirrhosis + stroke + renal_disease + diabetes_disease + cancer + leukemia_disease + lymphoma_disease + myocardial_infarction + chf + pvd + tia + dementia + copd + ctd + pud + liver_disease,
  data = final_dataset_eICU,
  family = binomial())
print(Sys.time())
```

### Odds ratio and Forest plot

```{r}
# Extract Odds ratio
or_hospdeath_1 <- extract_coef_pval_OR(logreg_hospdeath)

# Order variables
variable_order <- rev(c(
  "Intercept", "Age (years)", "Sex (male)", "PMV", "TBI-non severe", "TBI-severe", "Trauma-not TBI", "PMV + TBI-non severe", "PMV + TBI-severe", "PMV + Trauma - no TBI"))

# Assign proper names to OR table
or_hospdeath_2 <- or_hospdeath_1 %>% 
  mutate(term = case_when(term == "(Intercept)" ~ "Intercept",
                          term == "prolonged_mec_vent" ~ "PMV",
                          term == "trauma_type_anyseqtbi_non_severe" ~ "TBI-non severe",
                          term == "trauma_type_anyseqtbi_severe" ~ "TBI-severe",
                          term == "trauma_type_anyseqtrauma_non_tbi" ~ "Trauma-not TBI",
                          term == "prolonged_mec_vent:trauma_type_anyseqtbi_non_severe" ~ "PMV + TBI-non severe",
                          term == "prolonged_mec_vent:trauma_type_anyseqtbi_severe" ~ "PMV + TBI-severe",
                          term == "prolonged_mec_vent:trauma_type_anyseqtrauma_non_tbi" ~ "PMV + Trauma - no TBI",
                          term == "age" ~ "Age (years)",
                          term == "sexMale" ~ "Sex (male)",
                          TRUE ~ term), 
         term = factor(term, levels = variable_order),
         adverse_protective = case_when(
           OR_lower > 1 & OR_upper > 1 ~ "Adverse",
           OR_lower < 1 & OR_upper < 1 ~ "Protective",
           TRUE ~ "Inconclusive"
    ),
    adverse_protective = factor(adverse_protective, levels = c("Adverse", "Protective", "Inconclusive"))) %>%
  filter(term != "Intercept")

# Save OR table and print in console
write.csv(or_hospdeath_2,'C:/Users/se_al/Documents/GitHub/mimiciv-mec-vent/data/eICU/or_hospdeath_PMV-TBI_eicu.csv')
htmlTable(or_hospdeath_2[,c("term","OR","OR_lower","OR_upper")], caption = "Logistic Regression. Odds Ratio and Confidence Intervals for Hospital Mortality-associated Factors. eICU Database")

# Export OR table as kable 
or_table <- or_hospdeath_2 %>%
  select(term, OR, OR_lower, OR_upper) %>%
  mutate(
    term = factor(term, levels = variable_order),
    OR_upper = ifelse(OR_upper <= 100, sprintf("%.2f", OR_upper), sprintf("%.2e", OR_upper))) %>%
  arrange(desc(term)) %>%
  kbl(caption = "Logistic Regression. Odds Ratio and Confidence Intervals for Hospital Mortality-associated Factors. eICU Database" , align = "c") %>%
  kable_classic_2(full_width = F, html_font = "Cambria") %>%
  save_kable("C:/Users/se_al/Documents/GitHub/mimiciv-mec-vent/figures/eICU/Odds_ratio/or_hospdeath_PMV-TBI_eicu.png",
             zoom = 10)
 
# Build the Forest plot
ggplot(or_hospdeath_2, 
       aes(x = OR, xmin = OR_lower, xmax = OR_upper, y = term)) +
  geom_point(size = 2, aes(color = adverse_protective)) +
  geom_errorbarh(height = 0.2, aes(color = adverse_protective)) +
  geom_vline(xintercept = 1, linetype = "dashed") +
  labs(x = "Odds Ratio", y = NULL, title = "Logistic Regression. Odds Ratio and Confidence Intervals\nfor Hospital Mortality-associated Factors. eICU Database") +
  theme_minimal() +
  scale_color_manual(
    values = c("#c0392b", "#27ae60", "gray70"),
    labels = c("Adverse", "Protective", "Inconclusive"),
    name = "Effect on Outcome") +
  scale_x_continuous(limits = c(0, 13)) +
  theme(
    plot.background = element_rect(fill = "white"),
    panel.grid.major.y = element_blank(),
    panel.grid.minor.y = element_blank(),
    plot.title = element_text(hjust = 0.5),
    legend.position = "top",
    axis.ticks = element_blank(),
    axis.text.x = element_text(color = "#2c3e50"),
    axis.text.y = element_text(color = "#2c3e50"
    ))

# Save the Forest plot as a PNG file
ggsave("C:/Users/se_al/Documents/GitHub/mimiciv-mec-vent/figures/eICU/Forest_plot/fp_hospdeath_PMV-TBI_eicu.png", width = 10, height = 4, dpi = 300)
```

# 4 Logistic Regression with interaction: each trauma type

## Hospital Mortality: PMV and TBI-severe

### Fitting the model

```{r}
# Create subset with tbi_severe
final_dataset_eICU_tbi_severe <- subset(final_dataset_eICU, final_dataset_eICU$trauma_type_anyseq=="tbi_severe") 
print('Logistic Regression of year mortality')
print(Sys.time())
logreg_hospdeath <- glm(
   inhospital_death ~ age + sex + prolonged_mec_vent + aps + charlson + metastasis + hiv + liver_cirrhosis + stroke + renal_disease + diabetes_disease + cancer + leukemia_disease + lymphoma_disease + myocardial_infarction + chf + pvd + tia + dementia + copd + ctd + pud + liver_disease,
   data = final_dataset_eICU_tbi_severe,
  family = binomial())
print(Sys.time())
```

### Odds ratio and Forest plot

```{r}
# Extract Odds ratio
or_hospdeath_1 <- extract_coef_pval_OR(logreg_hospdeath)

# Save PMV's OR for this specific subset 
or_hospdeath_eicu_tbi_severe <- or_hospdeath_1[or_hospdeath_1[,1]=="prolonged_mec_vent", c(1,6:8)]
or_hospdeath_eicu_tbi_severe[, 1] <- "PMV for TBI severe"

# Order variables
variable_order <- rev(c(
  "Intercept", "Age (years)", "Sex (male)", "PMV"))

# Assign proper names to OR table
or_hospdeath_2 <- or_hospdeath_1 %>% 
  mutate(term = case_when(term == "(Intercept)" ~ "Intercept",
                          term == "prolonged_mec_vent" ~ "PMV",
                          term == "age" ~ "Age (years)",
                          term == "sexMale" ~ "Sex (male)",
                          TRUE ~ term), 
         term = factor(term, levels = variable_order),
         adverse_protective = case_when(
           OR_lower > 1 & OR_upper > 1 ~ "Adverse",
           OR_lower < 1 & OR_upper < 1 ~ "Protective",
           TRUE ~ "Inconclusive"
    ),
    adverse_protective = factor(adverse_protective, levels = c("Adverse", "Protective", "Inconclusive"))) %>%
  filter(term != "Intercept")

# Save OR table and print in console
write.csv(or_hospdeath_2,'C:/Users/se_al/Documents/GitHub/mimiciv-mec-vent/data/eICU/or_hospdeath_PMV-for-TBI-severe_eicu.csv')
htmlTable(or_hospdeath_2[,c("term","OR","OR_lower","OR_upper")], caption = "Logistic Regression. Odds Ratio and Confidence Intervals for factors associated with hospital mortality. Subset of TBI severe. eICU Database")

# Export OR table as kable 
or_table <- or_hospdeath_2 %>%
  select(term, OR, OR_lower, OR_upper) %>%
  mutate(
    term = factor(term, levels = variable_order),
    OR_upper = ifelse(OR_upper <= 100, sprintf("%.2f", OR_upper), sprintf("%.2e", OR_upper))) %>%
  arrange(desc(term)) %>%
  kbl(caption = "Logistic Regression. Odds Ratio and Confidence Intervals for factors associated with hospital mortality. Subset of TBI severe. eICU Database" , align = "c") %>%
  kable_classic_2(full_width = F, html_font = "Cambria") %>%
  save_kable("C:/Users/se_al/Documents/GitHub/mimiciv-mec-vent/figures/eICU/Odds_ratio/or_hospdeath_PMV-for-TBI-severe_eicu.png",
             zoom = 10)
 
# Build the Forest plot
ggplot(or_hospdeath_2, 
       aes(x = OR, xmin = OR_lower, xmax = OR_upper, y = term)) +
  geom_point(size = 2, aes(color = adverse_protective)) +
  geom_errorbarh(height = 0.2, aes(color = adverse_protective)) +
  geom_vline(xintercept = 1, linetype = "dashed") +
  labs(x = "Odds Ratio", y = NULL, title = "Logistic Regression. Odds Ratio and Confidence Intervals\nfor factors associated with hospital mortality.\nSubset of TBI severe. eICU Database") +
  theme_minimal() +
  scale_color_manual(
    values = c("#c0392b", "#27ae60", "gray70"),
    labels = c("Adverse", "Protective", "Inconclusive"),
    name = "Effect on Outcome",
    limits = adverse_protective_levels$adverse_protective) + #establishes limits of color scale
  scale_x_continuous(limits = c(0, 13)) +
  theme(
    plot.background = element_rect(fill = "white"),
    panel.grid.major.y = element_blank(),
    panel.grid.minor.y = element_blank(),
    plot.title = element_text(hjust = 0.5),
    legend.position = "top",
    axis.ticks = element_blank(),
    axis.text.x = element_text(color = "#2c3e50"),
    axis.text.y = element_text(color = "#2c3e50"
    ))

# Save the Forest plot as a PNG file
ggsave("C:/Users/se_al/Documents/GitHub/mimiciv-mec-vent/figures/eICU/Forest_plot/fp_hospdeath_PMV-for-TBI-severe_eicu.png", width = 10, height = 4, dpi = 300)
```

## Hospital Mortality: PMV and TBI-non severe

### Fitting the model

```{r}
# Create subset with tbi_severe
final_dataset_eICU_tbi_nonsevere <- subset(final_dataset_eICU, final_dataset_eICU$trauma_type_anyseq=="tbi_non_severe") 

print('Logistic Regression of year mortality')
print(Sys.time())
logreg_hospdeath <- glm(
   inhospital_death ~ age + sex + prolonged_mec_vent + aps + charlson + metastasis + hiv + liver_cirrhosis + stroke + renal_disease + diabetes_disease + cancer + leukemia_disease + lymphoma_disease + myocardial_infarction + chf + pvd + tia + dementia + copd + ctd + pud + liver_disease,
  data = final_dataset_eICU_tbi_nonsevere,
  family = binomial())
print(Sys.time())
```

### Odds ratio and Forest plot

```{r}
# Extract Odds ratio
or_hospdeath_1 <- extract_coef_pval_OR(logreg_hospdeath)

# Save PMV's OR for this specific subset 
or_hospdeath_eicu_tbi_nonsevere <- or_hospdeath_1[or_hospdeath_1[,1]=="prolonged_mec_vent", c(1,6:8)]
or_hospdeath_eicu_tbi_nonsevere[, 1] <- "PMV for TBI non-severe"

# Order variables
variable_order <- rev(c(
  "Intercept", "Age (years)", "Sex (male)", "PMV"))

# Assign proper names to OR table
or_hospdeath_2 <- or_hospdeath_1 %>% 
  mutate(term = case_when(term == "(Intercept)" ~ "Intercept",
                          term == "prolonged_mec_vent" ~ "PMV",
                          term == "age" ~ "Age (years)",
                          term == "sexMale" ~ "Sex (male)",
                          TRUE ~ term), 
         term = factor(term, levels = variable_order),
         adverse_protective = case_when(
           OR_lower > 1 & OR_upper > 1 ~ "Adverse",
           OR_lower < 1 & OR_upper < 1 ~ "Protective",
           TRUE ~ "Inconclusive"
    ),
    adverse_protective = factor(adverse_protective, levels = c("Adverse", "Protective", "Inconclusive"))) %>%
  filter(term != "Intercept")

# Save OR table and print in console
write.csv(or_hospdeath_2,'C:/Users/se_al/Documents/GitHub/mimiciv-mec-vent/data/eICU/or_hospdeath_PMV-for-TBI-nonsevere_eicu.csv')
htmlTable(or_hospdeath_2[,c("term","OR","OR_lower","OR_upper")], caption = "Logistic Regression. Odds Ratio and Confidence Intervals for factors associated with hospital mortality. Subset of TBI non-severe. eICU Database")

# Export OR table as kable 
or_table <- or_hospdeath_2 %>%
  select(term, OR, OR_lower, OR_upper) %>%
  mutate(
    term = factor(term, levels = variable_order),
    OR_upper = ifelse(OR_upper <= 100, sprintf("%.2f", OR_upper), sprintf("%.2e", OR_upper))) %>%
  arrange(desc(term)) %>%
  kbl(caption = "Logistic Regression. Odds Ratio and Confidence Intervals for factors associated with hospital mortality. Subset of TBI non-severe. eICU Database" , align = "c") %>%
  kable_classic_2(full_width = F, html_font = "Cambria") %>%
  save_kable("C:/Users/se_al/Documents/GitHub/mimiciv-mec-vent/figures/eICU/Odds_ratio/or_hospdeath_PMV-for-TBI-nonsevere_eicu.png",
             zoom = 10)
 
# Build the Forest plot
ggplot(or_hospdeath_2, 
       aes(x = OR, xmin = OR_lower, xmax = OR_upper, y = term)) +
  geom_point(size = 2, aes(color = adverse_protective)) +
  geom_errorbarh(height = 0.2, aes(color = adverse_protective)) +
  geom_vline(xintercept = 1, linetype = "dashed") +
  labs(x = "Odds Ratio", y = NULL, title = "Logistic Regression. Odds Ratio and Confidence Intervals\nfor factors associated with hospital mortality.\nSubset of TBI non-severe. eICU Database") +
  theme_minimal() +
  scale_color_manual(
    values = c("#c0392b", "#27ae60", "gray70"),
    labels = c("Adverse", "Protective", "Inconclusive"),
    name = "Effect on Outcome", 
    limits = adverse_protective_levels$adverse_protective) + #establishes limits of color scale
  scale_x_continuous(limits = c(0, 13)) +
  theme(
    plot.background = element_rect(fill = "white"),
    panel.grid.major.y = element_blank(),
    panel.grid.minor.y = element_blank(),
    plot.title = element_text(hjust = 0.5),
    legend.position = "top",
    axis.ticks = element_blank(),
    axis.text.x = element_text(color = "#2c3e50"),
    axis.text.y = element_text(color = "#2c3e50"
    ))

# Save the Forest plot as a PNG file
ggsave("C:/Users/se_al/Documents/GitHub/mimiciv-mec-vent/figures/eICU/Forest_plot/fp_hospdeath_PMV-for-TBI-nonsevere_eicu.png", width = 10, height = 4, dpi = 300)
```

## Hospital Mortality:: PMV and Trauma not-TBI

### Fitting the model

```{r}
# Create subset with tbi_severe
final_dataset_eICU_trauma_not_tbi <- subset(final_dataset_eICU, final_dataset_eICU$trauma_type_anyseq=="trauma_non_tbi") 

print('Logistic Regression of year mortality')
print(Sys.time())
logreg_hospdeath <- glm(
   inhospital_death ~ age + sex + prolonged_mec_vent + aps + charlson + metastasis + hiv + liver_cirrhosis + stroke + renal_disease + diabetes_disease + cancer + leukemia_disease + lymphoma_disease + myocardial_infarction + chf + pvd + tia + dementia + copd + ctd + pud + liver_disease,
  data = final_dataset_eICU_trauma_not_tbi,
  family = binomial())
print(Sys.time())
```

### Odds ratio and Forest plot

```{r}
# Extract Odds ratio
or_hospdeath_1 <- extract_coef_pval_OR(logreg_hospdeath)

# Save PMV's OR for this specific subset 
or_hospdeath_eicu_trauma_not_tbi <- or_hospdeath_1[or_hospdeath_1[,1]=="prolonged_mec_vent", c(1,6:8)]
or_hospdeath_eicu_trauma_not_tbi[, 1] <- "PMV for Trauma not-TBI"

# Order variables
variable_order <- rev(c(
  "Intercept", "Age (years)", "Sex (male)", "PMV"))

# Assign proper names to OR table
or_hospdeath_2 <- or_hospdeath_1 %>% 
  mutate(term = case_when(term == "(Intercept)" ~ "Intercept",
                          term == "prolonged_mec_vent" ~ "PMV",
                          term == "age" ~ "Age (years)",
                          term == "sexMale" ~ "Sex (male)",
                          TRUE ~ term), 
         term = factor(term, levels = variable_order),
         adverse_protective = case_when(
           OR_lower > 1 & OR_upper > 1 ~ "Adverse",
           OR_lower < 1 & OR_upper < 1 ~ "Protective",
           TRUE ~ "Inconclusive"
    ),
    adverse_protective = factor(adverse_protective, levels = c("Adverse", "Protective", "Inconclusive"))) %>%
  filter(term != "Intercept")

# Save OR table and print in console
write.csv(or_hospdeath_2,'C:/Users/se_al/Documents/GitHub/mimiciv-mec-vent/data/eICU/or_hospdeath_PMV-for-Trauma-not-TBI_eicu.csv')
htmlTable(or_hospdeath_2[,c("term","OR","OR_lower","OR_upper")], caption = "Logistic Regression. Odds Ratio and Confidence Intervals for factors associated with hospital mortality. Subset of Trauma not TBI. eICU Database")

# Export OR table as kable 
or_table <- or_hospdeath_2 %>%
  select(term, OR, OR_lower, OR_upper) %>%
  mutate(
    term = factor(term, levels = variable_order),
    OR_upper = ifelse(OR_upper <= 100, sprintf("%.2f", OR_upper), sprintf("%.2e", OR_upper))) %>%
  arrange(desc(term)) %>%
  kbl(caption = "Logistic Regression. Odds Ratio and Confidence Intervals for factors associated with hospital mortality. Subset of Trauma not TBI. eICU Database" , align = "c") %>%
  kable_classic_2(full_width = F, html_font = "Cambria") %>%
  save_kable("C:/Users/se_al/Documents/GitHub/mimiciv-mec-vent/figures/eICU/Odds_ratio/or_hospdeath_PMV-for-Trauma-not-TBI_eicu.png",
             zoom = 10)
 
# Build the Forest plot
ggplot(or_hospdeath_2, 
       aes(x = OR, xmin = OR_lower, xmax = OR_upper, y = term)) +
  geom_point(size = 2, aes(color = adverse_protective)) +
  geom_errorbarh(height = 0.2, aes(color = adverse_protective)) +
  geom_vline(xintercept = 1, linetype = "dashed") +
  labs(x = "Odds Ratio", y = NULL, title = "Logistic Regression. Odds Ratio and Confidence Intervals\nfor factors associated with hospital mortality.\nSubset of Trauma not TBI. eICU Database") +
  theme_minimal() +
  scale_color_manual(
    values = c("#c0392b", "#27ae60", "gray70"),
    labels = c("Adverse", "Protective", "Inconclusive"),
    name = "Effect on Outcome", 
    limits = adverse_protective_levels$adverse_protective) + #establishes limits of color scale
  scale_x_continuous(limits = c(0, 13)) +
  theme(
    plot.background = element_rect(fill = "white"),
    panel.grid.major.y = element_blank(),
    panel.grid.minor.y = element_blank(),
    plot.title = element_text(hjust = 0.5),
    legend.position = "top",
    axis.ticks = element_blank(),
    axis.text.x = element_text(color = "#2c3e50"),
    axis.text.y = element_text(color = "#2c3e50"
    ))

# Save the Forest plot as a PNG file
ggsave("C:/Users/se_al/Documents/GitHub/mimiciv-mec-vent/figures/eICU/Forest_plot/fp_hospdeath_PMV-for-Trauma-not-TBI_eicu.png", width = 10, height = 4, dpi = 300)
```

## Hospital Mortality: PMV and non Trauma

### Fitting the model

```{r}
# Create subset with tbi_severe
final_dataset_eICU_non_trauma <- subset(final_dataset_eICU, final_dataset_eICU$trauma_type_anyseq=="non_trauma") 

print('Logistic Regression of year mortality')
print(Sys.time())
logreg_hospdeath <- glm(
   inhospital_death ~ age + sex + prolonged_mec_vent + aps + charlson + metastasis + hiv + liver_cirrhosis + stroke + renal_disease + diabetes_disease + cancer + leukemia_disease + lymphoma_disease + myocardial_infarction + chf + pvd + tia + dementia + copd + ctd + pud + liver_disease,
  data = final_dataset_eICU_non_trauma,
  family = binomial())
print(Sys.time())
```

### Odds ratio and Forest plot

```{r}
# Extract Odds ratio
or_hospdeath_1 <- extract_coef_pval_OR(logreg_hospdeath)

# Save PMV's OR for this specific subset 
or_hospdeath_eicu_not_trauma <- or_hospdeath_1[or_hospdeath_1[,1]=="prolonged_mec_vent", c(1,6:8)]
or_hospdeath_eicu_not_trauma[, 1] <- "PMV for non Trauma"

# Order variables
variable_order <- rev(c(
  "Intercept", "Age (years)", "Sex (male)", "PMV"))

# Assign proper names to OR table
or_hospdeath_2 <- or_hospdeath_1 %>% 
  mutate(term = case_when(term == "(Intercept)" ~ "Intercept",
                          term == "prolonged_mec_vent" ~ "PMV",
                          term == "age" ~ "Age (years)",
                          term == "sexMale" ~ "Sex (male)",
                          TRUE ~ term), 
         term = factor(term, levels = variable_order),
         adverse_protective = case_when(
           OR_lower > 1 & OR_upper > 1 ~ "Adverse",
           OR_lower < 1 & OR_upper < 1 ~ "Protective",
           TRUE ~ "Inconclusive"
    ),
    adverse_protective = factor(adverse_protective, levels = c("Adverse", "Protective", "Inconclusive"))) %>%
  filter(term != "Intercept")

# Save OR table and print in console
write.csv(or_hospdeath_2,'C:/Users/se_al/Documents/GitHub/mimiciv-mec-vent/data/eICU/or_hospdeath_PMV-for-non-Trauma_eicu.csv')
htmlTable(or_hospdeath_2[,c("term","OR","OR_lower","OR_upper")], caption = "Logistic Regression. Odds Ratio and Confidence Intervals for factors associated with hospital mortality. Subset of not Trauma. eICU Database")

# Export OR table as kable 
or_table <- or_hospdeath_2 %>%
  select(term, OR, OR_lower, OR_upper) %>%
  mutate(
    term = factor(term, levels = variable_order),
    OR_upper = ifelse(OR_upper <= 100, sprintf("%.2f", OR_upper), sprintf("%.2e", OR_upper))) %>%
  arrange(desc(term)) %>%
  kbl(caption = "Logistic Regression. Odds Ratio and Confidence Intervals for factors associated with hospital mortality. Subset of not Trauma. eICU Database" , align = "c") %>%
  kable_classic_2(full_width = F, html_font = "Cambria") %>%
  save_kable("C:/Users/se_al/Documents/GitHub/mimiciv-mec-vent/figures/eICU/Odds_ratio/or_hospdeath_PMV-for-non-Trauma_eicu.png",
             zoom = 10)
 
# Build the Forest plot
ggplot(or_hospdeath_2, 
       aes(x = OR, xmin = OR_lower, xmax = OR_upper, y = term)) +
  geom_point(size = 2, aes(color = adverse_protective)) +
  geom_errorbarh(height = 0.2, aes(color = adverse_protective)) +
  geom_vline(xintercept = 1, linetype = "dashed") +
  labs(x = "Odds Ratio", y = NULL, title = "Logistic Regression. Odds Ratio and Confidence Intervals\nfor factors associated with hospital mortality.\nSubset of not Trauma. eICU Database") +
  theme_minimal() +
  scale_color_manual(
    values = c("#c0392b", "#27ae60", "gray70"),
    labels = c("Adverse", "Protective", "Inconclusive"),
    name = "Effect on Outcome", 
    limits = adverse_protective_levels$adverse_protective) + #establishes limits of color scale
  scale_x_continuous(limits = c(0, 13)) +
  theme(
    plot.background = element_rect(fill = "white"),
    panel.grid.major.y = element_blank(),
    panel.grid.minor.y = element_blank(),
    plot.title = element_text(hjust = 0.5),
    legend.position = "top",
    axis.ticks = element_blank(),
    axis.text.x = element_text(color = "#2c3e50"),
    axis.text.y = element_text(color = "#2c3e50"
    ))

# Save the Forest plot as a PNG file
ggsave("C:/Users/se_al/Documents/GitHub/mimiciv-mec-vent/figures/eICU/Forest_plot/fp_hospdeath_PMV-for-non-Trauma_eicu.png", width = 10, height = 4, dpi = 300)
```

## Combined results for PMV's OR for different trauma subsets

```{r}
# Obtain combined table
eICU_OR_PMV <- rbind(or_hospdeath_eicu_tbi_severe, or_hospdeath_eicu_tbi_nonsevere, or_hospdeath_eicu_trauma_not_tbi, or_hospdeath_eicu_not_trauma)

# Order variables
variable_order <- rev(c("Non Trauma", "non-TBI Trauma", "non-severe TBI", "severe TBI"))

# Assign proper names to OR table
eICU_OR_PMV_2 <- eICU_OR_PMV %>% 
  mutate(term = case_when(term == "(Intercept)" ~ "Intercept",
                          term == "PMV for Trauma not-TBI" ~ "non-TBI Trauma",
                          term == "PMV for TBI non-severe" ~ "non-severe TBI",
                          term == "PMV for TBI severe" ~ "severe TBI",
                          term == "PMV for non Trauma" ~ "Non Trauma",
                          TRUE ~ term), 
         term = factor(term, levels = variable_order),
         adverse_protective = case_when(
           OR_lower > 1 & OR_upper > 1 ~ "Adverse",
           OR_lower < 1 & OR_upper < 1 ~ "Protective",
           TRUE ~ "Inconclusive"
    ),
    adverse_protective = factor(adverse_protective, levels = c("Adverse", "Protective", "Inconclusive"))) %>%
  filter(term != "Intercept")

# Save OR table and print in console
write.csv(eICU_OR_PMV_2,'C:/Users/se_al/Documents/GitHub/mimiciv-mec-vent/data/eICU/OR_hospdeath_PMV_all-trauma_eicu.csv')
htmlTable(eICU_OR_PMV_2[,c("term","OR","OR_lower","OR_upper")], caption = "Odds Ratio and Confidence Intervals for factors associated with hospital mortality. All types of trauma. eICU Database")

# Export OR table as kable 
or_table <- eICU_OR_PMV_2 %>%
  select(term, OR, OR_lower, OR_upper) %>%
  mutate(
    term = factor(term, levels = variable_order),
    OR_upper = ifelse(OR_upper <= 100, sprintf("%.2f", OR_upper), sprintf("%.2e", OR_upper))) %>%
  arrange(desc(term)) %>%
  kbl(caption = "Logistic Regression. Odds Ratio and Confidence Intervals for factors associated with hospital mortality. All types of trauma. eICU Database" , align = "c") %>%
  kable_classic_2(full_width = F, html_font = "Cambria") %>%
  save_kable("C:/Users/se_al/Documents/GitHub/mimiciv-mec-vent/figures/eICU/Odds_ratio/OR_hospdeath_PMV_all-trauma_eicu.png",
             zoom = 10)
 
# Build the Forest plot
fp_PMV_alltraumas_hospdeath_eicu <- ggplot(eICU_OR_PMV_2, 
       aes(x = OR, xmin = OR_lower, xmax = OR_upper, y = term)) +
  geom_point(size = 2, aes(color = adverse_protective)) +
  geom_errorbarh(height = 0.2, aes(color = adverse_protective)) +
  geom_vline(xintercept = 1, linetype = "dashed") +
  labs(x = "Odds Ratio", y = NULL, title = "Logistic Regression. Odds Ratio and Confidence Intervals\nfor factors associated with hospital mortality.\nAll types of trauma. eICU Database") +
  theme_minimal() +
  scale_color_manual(
    values = c("#c0392b", "#27ae60", "gray70"),
    labels = c("Adverse", "Protective", "Inconclusive"),
    name = "Effect on Outcome", 
    limits = adverse_protective_levels$adverse_protective) + #establishes limits of color scale
  scale_x_continuous(limits = c(0, 8)) +
  theme(
    plot.background = element_rect(fill = "white"),
    panel.grid.major.y = element_blank(),
    panel.grid.minor.y = element_blank(),
    plot.title = element_text(hjust = 0.5),
    legend.position = "top",
    axis.ticks = element_blank(),
    axis.text.x = element_text(color = "#2c3e50"),
    axis.text.y = element_text(color = "#2c3e50"
    ))
fp_PMV_alltraumas_hospdeath_eicu

# Save the Forest plot as a PNG file
ggsave("C:/Users/se_al/Documents/GitHub/mimiciv-mec-vent/figures/eICU/Forest_plot/fp_hospdeath_PMV_all-trauma_eicu.png", plot = fp_PMV_alltraumas_hospdeath_eicu, width = 10, height = 4, dpi = 300)

```


# Interaction of PMV and Trauma types

```{r}
print('Logistic Regression of hospital mortality')
print(Sys.time())
logreg_hospdeath <- glm(
   inhospital_death ~ prolonged_mec_vent * trauma_type_anyseq + age + sex + aps + charlson + metastasis + hiv + liver_cirrhosis + stroke + renal_disease + diabetes_disease + cancer + leukemia_disease + lymphoma_disease + myocardial_infarction + chf + pvd + tia + dementia + copd + ctd + pud + liver_disease,
  data = final_dataset_eICU,
  family = binomial())
print(Sys.time())

# Print the model summary
print('Model summary of logistic regression model with interaction term between PMV and trauma type for hospital death')
summary(logreg_hospdeath)

# Perform an analysis of variance (ANOVA) to test the significance of the interaction
anova(logreg_hospdeath, test = "Chisq")

print('If the interaction is significant, we can proceed with post-hoc analyses to explore the nature of the interaction')

# Plot the interaction effect
ggplot(final_dataset_eICU, aes(x = prolonged_mec_vent, y = inhospital_death, color = factor(trauma_type_anyseq))) +
  geom_point() +
  geom_smooth(method = "glm", method.args = list(family = "binomial"), se = FALSE) +
  labs(x = "Prolonged Mechanical Ventilation", y = "Hospital Mortality", color = "Type of Trauma", title = "Interaction Effect of PMV and Trauma types on Hospital Death. eICU Database") +
  theme_minimal()

# Save the plot as a PNG file
ggsave("C:/Users/se_al/Documents/GitHub/mimiciv-mec-vent/figures/eICU/Forest_plot/interactionplot_PMV-TBI_eicu.png", width = 6, height = 4, dpi = 300)

```

# Correlation between TBI and age
```{r}
# Calculate the point-biserial correlation
correlation_tbi_age <- cor.test(final_dataset_eICU$tbi_severe_anyseq, final_dataset_eICU$age)

# Print the correlation coefficient and p-value
cat("Point-biserial correlation coefficient:", correlation_tbi_age$estimate, "\n")
cat("p-value:", correlation_tbi_age$p.value, "\n")

# Check if the correlation is significant
if (correlation_tbi_age$p.value < 0.05) {
  cat("The correlation is significant.\n")
} else {
  cat("The correlation is not significant.\n")
}

```

